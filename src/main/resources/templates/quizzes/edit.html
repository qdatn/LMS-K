<div class="px-5" th:fragment="content">
  <div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-4">
      <!-- Header -->
      <div class="card-header bg-primary text-white rounded-top-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-question-circle me-2 fs-4"></i>
          <h1 class="mb-0 fw-bold">Update Quiz</h1>
        </div>
        <button type="button" id="toggleQuizDetails" class="btn btn-outline-light btn-sm">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>

      <div class="card-body p-4">
        <!-- Success Message -->
        <div th:if="${successMessage}" class="alert alert-success d-flex align-items-center" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          <span th:text="${successMessage}"></span>
        </div>

        <!-- Error Message -->
        <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span th:text="${error}"></span>
        </div>

        <form th:action="@{/quizzes/edit/{id}(id=${quiz.id})}" th:object="${quiz}" method="post" onsubmit="return validateForm()">
          <input type="hidden" th:field="*{id}" />

          <!-- Quiz Details Container -->
          <div id="quizDetails" class="mb-4" style="display: none;">
            <!-- Quiz Name -->
            <div class="mb-4">
              <label for="name" class="form-label fw-semibold">
                <i class="bi bi-tag me-2"></i>Quiz Name
              </label>
              <input type="text" class="form-control border-0 shadow-sm rounded-3" id="name"
                     th:field="*{name}" placeholder="Enter quiz name" required>
            </div>

            <!-- Description and Course in one row -->
            <div class="row">
              <!-- Description -->
              <div class="col-md-6 mb-4">
                <label for="description" class="form-label fw-semibold">
                  <i class="bi bi-text-paragraph me-2"></i>Description
                </label>
                <textarea class="form-control border-0 shadow-sm rounded-3" id="description"
                          th:field="*{description}" placeholder="Enter description"></textarea>
              </div>

              <!-- Course -->
              <div class="col-md-6 mb-4">
                <label for="courseId" class="form-label fw-semibold">
                  <i class="bi bi-journal-bookmark me-2"></i>Course
                </label>
                <select class="form-select border-0 shadow-sm rounded-3" id="courseId"
                        name="courseId" required>
                  <option value="">Select Course</option>
                  <option th:each="course : ${courses}" th:value="${course.id}"
                          th:text="${course.name}"
                          th:selected="${course.id == quiz.course?.id}"></option>
                </select>
              </div>
            </div>
          </div>

          <!-- Khu vực thông báo -->
          <div id="notification-area" class="position-fixed top-0 end-0 p-3" style="z-index: 1000;"></div>

          <!-- Hidden Question IDs -->
          <div id="questionIdsContainer">
            <input type="hidden" name="questionIds" th:each="question : ${quiz.questions}"
                   th:value="${question.id}" />
          </div>

          <div class="row">
            <!-- Add Questions From Other Quiz -->
            <div class="col-md-6 mb-4" th:unless="${quiz.isInBank}">
              <div class="card shadow-sm border-0 rounded-3">
                <div class="card-header bg-dark text-white rounded-top-3 d-flex align-items-center">
                  <i class="bi bi-plus-circle me-2"></i>
                  <h5 class="mb-0">Add Questions From Other Quiz</h5>
                </div>
                <div class="card-body">
                  <div class="input-group mb-3">
                    <i class="bi bi-search input-group-text bg-light border-0"></i>
                    <input type="text" class="form-control border-0 shadow-sm rounded-3" id="searchQuiz" placeholder="Search quiz...">
                  </div>
                  <div class="border p-2 rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                    <div id="quizList">
                      <div th:each="otherQuiz, iter : ${otherQuizzes}" class="quiz-item p-2 rounded-2 hover-effect">
                        <div class="d-flex justify-content-between align-items-center quiz-container" th:data-quiz-id="${otherQuiz.id}">
                          <span th:text="${iter.count} + '. ' +${otherQuiz.name}"></span>
                          <div>
                            <span class="badge bg-success" th:text="${otherQuiz.questions.size()}"></span>
                            <button type="button" class="btn btn-sm btn-outline-primary add-all-questions-btn ms-2" th:data-quiz-id="${otherQuiz.id}">
                              <i class="bi bi-plus-circle"></i>
                            </button>
                          </div>
                        </div>
                        <div class="questions-list mt-2" style="display: none;">
                          <div th:each="question, questionIter : ${otherQuiz.questions}" class="p-2 mb-2 rounded-2 bg-white shadow-sm">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="d-flex justify-content-between align-items-center">
                                <span th:text="${questionIter.count} + '. '" class="question-number me-2 fw-bold"></span>
                                <strong th:utext="${question.text}" class="question-text flex-grow-1"></strong>
                              </div>
                              <button type="button" class="btn btn-primary btn-sm add-question-btn" th:data-question-id="${question.id}">
                                <i class="bi bi-plus"></i>
                              </button>
                            </div>
                            <ul class="list-group mt-2 answers-list" style="display: none;">
                              <li th:each="answer : ${question.answers}" class="list-group-item d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" th:checked="${answer.isCorrect}" disabled>
                                <span th:text="${answer.text}"></span>
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Current Questions -->
            <div th:classappend="${quiz.isInBank} ? 'col-md-12 mb-4' : 'col-md-6 mb-4'">
              <div class="card shadow-sm border-0 rounded-3">
                <div class="card-header bg-dark text-white rounded-top-3 d-flex align-items-center">
                  <i class="bi bi-list-check me-2"></i>
                  <h5 class="mb-0">Current Questions</h5>
                </div>
                <div class="card-body">
                  <div class="d-flex mb-3 gap-2">
                    <button type="button" class="btn btn-info btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#aiQuestionModal" title="Add questions using AI">
                      <i class="bi bi-robot"></i>
                    </button>
                    <a th:href="@{/questions/{id}(id=${quiz.id})}" class="btn btn-primary btn-sm shadow-sm" title="Add questions">
                      <i class="bi bi-plus"></i>
                    </a>
                    <a th:href="@{/questions/print/{id}(id=${quiz.id})}" class="btn btn-primary btn-sm shadow-sm" target="_blank" title="Print">
                      <i class="bi bi-printer"></i>
                    </a>
                    <a class="btn btn-primary btn-sm shadow-sm" title="Import from Excel">
                      <i class="bi bi-file-earmark-arrow-up"></i> Excel
                    </a>
                    <a th:href="@{/questions/export/{id}(id=${quiz.id})}" class="btn btn-primary btn-sm shadow-sm" title="Export to Excel">
                      <i class="bi bi-file-earmark-arrow-down"></i> Export
                    </a>
                    <button type="button" id="deleteSelectedQuestionsBtn" class="btn btn-danger btn-sm shadow-sm d-flex align-items-center" disabled>
                      <i class="fas fa-trash-alt me-2"></i> Delete(<span id="selectedCountQuestions">0</span>)
                    </button>
                  </div>
                  <div id="current-quiz-questions" class="border p-2 rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                    <div th:each="question, iterStat : ${quiz.questions}" class="p-2 mb-2 rounded-2 hover-effect" th:id="'question-' + ${question.id}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-grow-1">
                          <input type="checkbox" class="select-question me-2" th:value="${question.id}" />
                          <span class="me-2 fw-bold" th:text="${iterStat.count} + '.'"></span>
                          <strong th:utext="${question.text}" class="flex-grow-1"></strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary move-up-btn" th:data-question-id="${question.id}">
                            <i class="bi bi-arrow-up"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-secondary move-down-btn" th:data-question-id="${question.id}">
                            <i class="bi bi-arrow-down"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-secondary" th:onclick="|window.location.href='/questions/edit/${question.id}?quizId=${quiz.id}'|">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-secondary remove-question-btn" th:data-question-id="${question.id}">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mt-2">
                        <div th:each="answer : ${question.answers}" class="form-check">
                          <input class="form-check-input" type="checkbox" th:checked="${answer.isCorrect}" disabled>
                          <label class="form-check-label" th:text="${answer.text}"></label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary px-4 me-3 shadow-lg rounded-3">
              <i class="bi bi-save me-2"></i>Save
            </button>
            <a href="/quizzes" class="btn btn-outline-secondary px-4 shadow-lg rounded-3">
              <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
          </div>
        </form>

        <!-- Modal để nhập thông tin AI và chọn câu hỏi -->
        <div class="modal fade" id="aiQuestionModal" tabindex="-1" aria-labelledby="aiQuestionModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="aiQuestionModalLabel"><i class="bi bi-robot me-2"></i>Generate Questions with AI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Form nhập thông tin AI -->
                <form id="aiQuestionForm" th:action="@{/quizzes/{quizId}/generate-ai-questions(quizId=${quiz.id})}" method="post">
                  <div class="mb-3">
                    <label for="aiTopic" class="form-label">Topic</label>
                    <input type="text" class="form-control" id="aiTopic" name="topic" placeholder="e.g., Java" required>
                  </div>
                  <div class="mb-3">
                    <label for="aiType" class="form-label">Question Type</label>
                    <select class="form-select" id="aiType" name="type" required>
                      <option value="MULTIPLE CHOICE">Multiple Choice</option>
                      <option value="TRUE FALSE">True/False</option>
                      <option value="FILL IN THE BLANK">Fill in the Blank</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="aiNumberOfQuestions" class="form-label">Number of Questions</label>
                    <input type="number" class="form-control" id="aiNumberOfQuestions" name="numberOfQuestions" min="1" required>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Generate</button>
                  </div>
                </form>

                <!-- Phần hiển thị câu hỏi được tạo bởi AI -->
                <div id="aiGeneratedQuestions" style="display: none;">
                  <h5>Generated Questions</h5>
                  <form id="saveAIQuestionsForm" th:action="@{/quizzes/{quizId}/save-ai-questions(quizId=${quiz.id})}" method="post">
                    <div id="aiQuestionsList" class="border p-2 rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                      <!-- Danh sách câu hỏi sẽ được thêm bằng JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button type="submit" class="btn btn-primary">Save Selected Questions</button>
                      <button type="button" class="btn btn-secondary" id="cancelAIQuestions">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .hover-effect:hover {
      background-color: #f8f9fa;
      transition: background-color 0.2s;
    }
  </style>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
      // Hàm hiển thị thông báo
      function showNotification(message, type = 'danger') {
        const notificationArea = document.getElementById('notification-area');
        const notificationId = 'notification-' + Date.now();
        const notificationHtml = `
          <div id="${notificationId}" class="alert alert-${type} alert-dismissible fade show shadow-lg" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        notificationArea.insertAdjacentHTML('beforeend', notificationHtml);
        setTimeout(() => {
          const notification = document.getElementById(notificationId);
          if (notification) {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 500);
          }
        }, 5000);
      }

      // Hàm cập nhật số thứ tự câu hỏi
      function updateQuestionNumbers() {
        const questions = document.querySelectorAll('#current-quiz-questions > div');
        questions.forEach((question, index) => {
          const numberSpan = question.querySelector('span.fw-bold');
          if (numberSpan) numberSpan.textContent = `${index + 1}.`;
        });
      }

      // Hàm lọc danh sách quiz
      function filterQuizzes() {
        const searchInput = document.getElementById('searchQuiz');
        if (!searchInput) {
          console.error('Không tìm thấy #searchQuiz');
          return;
        }
        const searchValue = searchInput.value.toLowerCase();
        const quizItems = document.querySelectorAll('.quiz-item');
        quizItems.forEach(item => {
          const quizName = item.querySelector('.quiz-container span').textContent.toLowerCase();
          item.style.display = quizName.includes(searchValue) ? 'block' : 'none';
        });
      }

      // Gắn sự kiện keyup cho ô tìm kiếm
      const searchQuizInput = document.getElementById('searchQuiz');
      if (searchQuizInput) {
        searchQuizInput.addEventListener('keyup', filterQuizzes);
      } else {
        console.error('Không tìm thấy #searchQuiz trong DOM');
      }

      // Cập nhật số lượng câu hỏi được chọn và trạng thái nút Delete
      function updateDeleteButton() {
        const checkboxes = document.querySelectorAll('.select-question');
        const deleteBtn = document.getElementById('deleteSelectedQuestionsBtn');
        const selectedCountSpan = document.getElementById('selectedCountQuestions');
        const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
        selectedCountSpan.textContent = checkedCount;
        deleteBtn.disabled = checkedCount === 0;
      }

      // Toggle quiz details
      const toggleQuizDetailsBtn = document.getElementById('toggleQuizDetails');
      const quizDetails = document.getElementById('quizDetails');
      toggleQuizDetailsBtn.addEventListener('click', function() {
        if (quizDetails.style.display === 'none') {
          quizDetails.style.display = 'block';
          this.innerHTML = '<i class="bi bi-chevron-down"></i>';
        } else {
          quizDetails.style.display = 'none';
          this.innerHTML = '<i class="bi bi-chevron-up"></i>';
        }
      });

      // Toggle questions list
      document.querySelectorAll('.quiz-container').forEach(container => {
        container.addEventListener('click', function() {
          const questionsList = this.nextElementSibling;
          questionsList.style.display = questionsList.style.display === 'none' ? 'block' : 'none';
        });
      });

      // Toggle answers list
      document.querySelectorAll('.question-text').forEach(text => {
        text.addEventListener('click', function() {
          const answersList = this.parentElement.nextElementSibling;
          answersList.style.display = answersList.style.display === 'none' ? 'block' : 'none';
        });
      });

      // Di chuyển câu hỏi lên
      document.querySelectorAll('.move-up-btn').forEach(button => {
        button.addEventListener('click', function() {
          const questionId = this.getAttribute('data-question-id');
          const questionDiv = document.getElementById(`question-${questionId}`);
          const previousSibling = questionDiv.previousElementSibling;
          if (previousSibling) {
            questionDiv.parentNode.insertBefore(questionDiv, previousSibling);
            updateQuestionNumbers();
            // Gửi yêu cầu cập nhật thứ tự lên server nếu cần
            updateQuestionOrderOnServer();
          }
        });
      });

      // Di chuyển câu hỏi xuống
      document.querySelectorAll('.move-down-btn').forEach(button => {
        button.addEventListener('click', function() {
          const questionId = this.getAttribute('data-question-id');
          const questionDiv = document.getElementById(`question-${questionId}`);
          const nextSibling = questionDiv.nextElementSibling;
          if (nextSibling) {
            questionDiv.parentNode.insertBefore(nextSibling, questionDiv);
            updateQuestionNumbers();
            // Gửi yêu cầu cập nhật thứ tự lên server nếu cần
            updateQuestionOrderOnServer();
          }
        });
      });

      // Add single question
      document.querySelectorAll('.add-question-btn').forEach(button => {
        button.addEventListener('click', function() {
          const questionId = this.getAttribute('data-question-id');
          const questionDiv = this.closest('.p-2.mb-2.rounded-2');
          const questionText = questionDiv.querySelector('.question-text').textContent.trim();
          const answersHtml = questionDiv.querySelector('.answers-list').innerHTML;

          const questionList = document.getElementById('current-quiz-questions');
          const newQuestion = document.createElement('div');
          newQuestion.classList.add('p-2', 'mb-2', 'rounded-2', 'hover-effect');
          newQuestion.id = `question-${questionId}`;
          newQuestion.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <input type="checkbox" class="select-question me-2" value="${questionId}" />
                <span class="me-2 fw-bold">${questionList.children.length + 1}.</span>
                <strong>${questionText}</strong>
              </div>
              <div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/questions/edit/${questionId}?quizId=${[[${quiz.id}]]}'">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary remove-question-btn" data-question-id="${questionId}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            <div class="mt-2">${answersHtml}</div>
          `;
          questionList.appendChild(newQuestion);

          const questionIdsContainer = document.getElementById('questionIdsContainer');
          const newInput = document.createElement('input');
          newInput.type = 'hidden';
          newInput.name = 'questionIds';
          newInput.value = questionId;
          questionIdsContainer.appendChild(newInput);

          newQuestion.querySelector('.remove-question-btn').addEventListener('click', removeQuestion);

          fetch(`/quizzes/${[[${quiz.id}]]}/add-question/${questionId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
                  .then(response => response.json())
                  .then(data => {
                    if (!data.success) {
                      showNotification(data.message);
                      newQuestion.remove();
                      questionIdsContainer.removeChild(newInput);
                    } else {
                      showNotification('Thêm câu hỏi thành công', 'success');
                      updateDeleteButton();
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    showNotification('Đã xảy ra lỗi khi thêm câu hỏi!');
                    newQuestion.remove();
                    questionIdsContainer.removeChild(newInput);
                  });
        });
      });

      // Add all questions from a quiz
      document.querySelectorAll('.add-all-questions-btn').forEach(button => {
        button.addEventListener('click', function() {
          const sourceQuizId = this.getAttribute('data-quiz-id');
          const quizItem = this.closest('.quiz-item');
          const questionCount = quizItem.querySelector('.badge').textContent;

          Swal.fire({
            title: 'Are you sure?',
            text: `You are about to add all ${questionCount} questions from this quiz.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, add them!'
          }).then((result) => {
            if (result.isConfirmed) {
              fetch(`/quizzes/${[[${quiz.id}]]}/add-all-questions-from-quiz/${sourceQuizId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              })
                      .then(response => response.json())
                      .then(data => {
                        if (!data.success) {
                          showNotification(data.message);
                          return;
                        }

                        const questionList = document.getElementById('current-quiz-questions');
                        const questionIdsContainer = document.getElementById('questionIdsContainer');

                        data.addedQuestions.forEach(q => {
                          const questionId = q.questionId;
                          const questionText = q.questionText;
                          const answersHtml = q.answers.map(a => `
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" ${a.isCorrect ? 'checked' : ''} disabled>
                              <label class="form-check-label">${a.text}</label>
                            </div>
                          `).join('');

                          const newQuestion = document.createElement('div');
                          newQuestion.classList.add('p-2', 'mb-2', 'rounded-2', 'hover-effect');
                          newQuestion.id = `question-${questionId}`;
                          newQuestion.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="d-flex align-items-center">
                                <input type="checkbox" class="select-question me-2" value="${questionId}" />
                                <span class="me-2 fw-bold">${questionList.children.length + 1}.</span>
                                <strong>${questionText}</strong>
                              </div>
                              <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/questions/edit/${questionId}?quizId=${[[${quiz.id}]]}'">
                                  <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-question-btn" data-question-id="${questionId}">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </div>
                            </div>
                            <div class="mt-2">${answersHtml}</div>
                          `;
                          questionList.appendChild(newQuestion);

                          const newInput = document.createElement('input');
                          newInput.type = 'hidden';
                          newInput.name = 'questionIds';
                          newInput.value = questionId;
                          questionIdsContainer.appendChild(newInput);

                          newQuestion.querySelector('.remove-question-btn').addEventListener('click', removeQuestion);
                        });

                        showNotification(data.message, 'success');
                        updateDeleteButton();
                      })
                      .catch(error => {
                        console.error('Error:', error);
                        showNotification('Đã xảy ra lỗi khi thêm tất cả câu hỏi!');
                      });
            }
          });
        });
      });

      // Remove question
      function removeQuestion() {
        const questionId = this.getAttribute('data-question-id');
        const questionDiv = document.getElementById(`question-${questionId}`);
        if (questionDiv) questionDiv.remove();

        const questionIdsContainer = document.getElementById('questionIdsContainer');
        const inputs = questionIdsContainer.querySelectorAll('input[name="questionIds"]');
        inputs.forEach(input => {
          if (input.value === questionId) questionIdsContainer.removeChild(input);
        });

        fetch(`/quizzes/${[[${quiz.id}]]}/remove-question/${questionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
                .then(response => response.json())
                .then(data => {
                  if (!data.success) showNotification(data.message);
                  else {
                    showNotification('Xóa câu hỏi thành công', 'success');
                    updateDeleteButton();
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showNotification('Đã xảy ra lỗi khi xóa câu hỏi!');
                });
      }

      document.querySelectorAll('.remove-question-btn').forEach(button => {
        button.addEventListener('click', removeQuestion);
      });

      // Xử lý khi checkbox thay đổi
      const checkboxes = document.querySelectorAll('.select-question');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButton);
      });

      // Xử lý xóa nhiều câu hỏi được chọn
      const deleteSelectedBtn = document.getElementById('deleteSelectedQuestionsBtn');
      deleteSelectedBtn.addEventListener('click', function() {
        const selectedIds = [...document.querySelectorAll('.select-question:checked')].map(cb => cb.value);

        if (selectedIds.length === 0) {
          Swal.fire('Warning', 'Please select at least one question to delete.', 'warning');
          return;
        }

        Swal.fire({
          title: 'Are you sure?',
          text: `You are about to delete ${selectedIds.length} question(s).`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete them!'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/quizzes/${[[${quiz.id}]]}/delete-selected-questions`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ids: selectedIds })
            })
                    .then(response => {
                      if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || 'Failed to delete questions'); });
                      }
                      return response.text();
                    })
                    .then(() => {
                      Swal.fire('Deleted!', 'Selected questions have been deleted.', 'success').then(() => {
                        selectedIds.forEach(id => {
                          const questionDiv = document.getElementById(`question-${id}`);
                          if (questionDiv) questionDiv.remove();
                          const questionIdsContainer = document.getElementById('questionIdsContainer');
                          const inputs = questionIdsContainer.querySelectorAll('input[name="questionIds"]');
                          inputs.forEach(input => {
                            if (input.value === id) questionIdsContainer.removeChild(input);
                          });
                        });
                        updateDeleteButton();
                      });
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      Swal.fire('Error', error.message, 'error');
                    });
          }
        });
      });

      // Xử lý khi submit form tạo câu hỏi AI
      document.getElementById('aiQuestionForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
          method: 'POST',
          body: formData
        })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Ẩn form nhập thông tin và hiển thị danh sách câu hỏi
                    document.getElementById('aiQuestionForm').style.display = 'none';
                    const aiGeneratedQuestions = document.getElementById('aiGeneratedQuestions');
                    aiGeneratedQuestions.style.display = 'block';

                    // Xóa danh sách câu hỏi cũ (nếu có)
                    const aiQuestionsList = document.getElementById('aiQuestionsList');
                    aiQuestionsList.innerHTML = '';

                    // Thêm các câu hỏi được tạo vào danh sách
                    data.questions.forEach((question, index) => {
                      const questionDiv = document.createElement('div');
                      questionDiv.classList.add('p-2', 'mb-2', 'rounded-2', 'bg-white', 'shadow-sm');
                      questionDiv.innerHTML = `
                  <div class="d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" name="selectedQuestionIds" value="${question.id}" checked>
                    <span class="fw-bold me-2">${index + 1}.</span>
                    <strong>${question.text}</strong>
                  </div>
                  <div class="mt-2">
                    ${question.answers.map(answer => `
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" disabled ${answer.isCorrect ? 'checked' : ''}>
                        <label class="form-check-label">${answer.text}</label>
                      </div>
                    `).join('')}
                  </div>
                `;
                      aiQuestionsList.appendChild(questionDiv);
                    });
                  } else {
                    showNotification(data.message, 'danger');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showNotification('Đã xảy ra lỗi khi tạo câu hỏi!');
                });
      });

      // Xử lý khi hủy việc lưu câu hỏi
      document.getElementById('cancelAIQuestions').addEventListener('click', function() {
        document.getElementById('aiGeneratedQuestions').style.display = 'none';
        document.getElementById('aiQuestionForm').style.display = 'block';
        document.getElementById('aiQuestionsList').innerHTML = '';
      });

      // Xử lý khi submit form lưu câu hỏi được chọn
      document.getElementById('saveAIQuestionsForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
          method: 'POST',
          body: formData
        })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Đóng modal và hiển thị thông báo thành công
                    const modal = bootstrap.Modal.getInstance(document.getElementById('aiQuestionModal'));
                    modal.hide();
                    showNotification(data.message, 'success');

                    // Cập nhật danh sách câu hỏi hiện tại
                    const questionList = document.getElementById('current-quiz-questions');
                    data.addedQuestions.forEach(question => {
                      const newQuestion = document.createElement('div');
                      newQuestion.classList.add('p-2', 'mb-2', 'rounded-2', 'hover-effect');
                      newQuestion.id = `question-${question.id}`;
                      newQuestion.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                      <input type="checkbox" class="select-question me-2" value="${question.id}" />
                      <span class="me-2 fw-bold">${questionList.children.length + 1}.</span>
                      <strong>${question.text}</strong>
                    </div>
                    <div>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/questions/edit/${question.id}?quizId=${[[${quiz.id}]]}'">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary remove-question-btn" data-question-id="${question.id}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="mt-2">
                    ${question.answers.map(answer => `
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" ${answer.isCorrect ? 'checked' : ''} disabled>
                        <label class="form-check-label">${answer.text}</label>
                      </div>
                    `).join('')}
                  </div>
                `;
                      questionList.appendChild(newQuestion);

                      // Thêm sự kiện cho nút xóa
                      newQuestion.querySelector('.remove-question-btn').addEventListener('click', removeQuestion);

                      // Thêm questionId vào questionIdsContainer
                      const questionIdsContainer = document.getElementById('questionIdsContainer');
                      const newInput = document.createElement('input');
                      newInput.type = 'hidden';
                      newInput.name = 'questionIds';
                      newInput.value = question.id;
                      questionIdsContainer.appendChild(newInput);
                    });

                    updateDeleteButton();
                  } else {
                    showNotification(data.message, 'danger');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showNotification('Đã xảy ra lỗi khi lưu câu hỏi!');
                });
      });

      // Form validation
      window.validateForm = function() {
        const name = document.getElementById('name').value;
        const courseId = document.getElementById('courseId').value;
        const description = document.getElementById('description').value;
        const questions = document.querySelectorAll('#current-quiz-questions > div').length;

        if (!name) {
          showNotification('Please enter a quiz name!');
          return false;
        }
        if (!courseId) {
          showNotification('Please select a course!');
          return false;
        }
        if (description.length > 255) {
          showNotification('Description cannot exceed 255 characters!');
          return false;
        }
        if (questions === 0) {
          showNotification('Please add at least one question!');
          return false;
        }
        return true;
      };

      // Khởi tạo trạng thái ban đầu
      updateDeleteButton();
    });

    // Hàm gửi yêu cầu cập nhật thứ tự câu hỏi lên server
    function updateQuestionOrderOnServer() {
      const questionIds = [...document.querySelectorAll('#current-quiz-questions > div')]
              .map(div => div.id.replace('question-', ''));

      fetch(`/quizzes/${[[${quiz.id}]]}/update-question-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questionIds })
      })
              .then(response => response.json())
              .then(data => {
                if (!data.success) {
                  showNotification(data.message, 'danger');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật thứ tự câu hỏi!');
              });
    }
  </script>
</div>