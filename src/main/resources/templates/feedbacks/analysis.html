<div class="px-5" th:fragment="content" xmlns:th="http://www.w3.org/1999/xhtml">
    <div class="container py-2">
        <!-- Tab Navigation -->
        <div th:replace="feedbacks/fragment/navbar-feed-back :: tab-navigation"></div>

        <!-- Header -->
        <div class="col-12 text-center mb-4">
            <h1 class="fw-bold">Feedback Analysis</h1>
        </div>

        <!-- Course Feedback Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h2 class="card-title fw-bold mb-4">Course’s Criteria Report Graph</h2>

                <!-- Search Form -->
                <form method="get" th:action="@{/feedbacks/analysis}" id="courseAnalysisForm">
                    <div class="row align-items-center gy-3 mb-4">
                        <div class="col-md-6 d-flex">
                            <div class="input-group me-2 flex-grow-1">
                                <input list="courseList" name="courseName" id="courseSelect" class="form-control"
                                       placeholder="Search by course name" onchange="this.form.submit()">
                                <datalist id="courseList">
                                    <option value="">All Courses</option>
                                    <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                                </datalist>
                                <input type="hidden" name="courseId" id="courseId">
                                <button type="submit" class="btn btn-sm btn-outline-secondary" aria-label="Search" title="Search">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Charts -->
                <div th:if="${courseChartData != null and !courseChartData.isEmpty()}" class="row">
                    <!-- Bar Charts Container -->
                    <div class="col-md-8">
                        <div class="chart-container" style="max-height: 400px; overflow-y: auto;">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="practicalApplicationsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="clarityOfExplanationChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="courseStructureChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="clarityOfMaterialChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="supportMaterialsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="uptodateMaterialsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Pie Chart -->
                    <div class="col-md-4 d-flex flex-column align-items-center">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h3 class="text-center mb-3">Overall Ratings</h3>
                                <canvas id="CoursePieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State for Course Charts -->
                <div th:if="${courseChartData == null or courseChartData.isEmpty()}" class="card border-0 shadow-sm p-4 text-center">
                    <div class="py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5>No Data Available</h5>
                        <p class="text-muted">There are no course feedback data available for analysis.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructor Feedback Section -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h2 class="card-title fw-bold mb-4">Instructor Feedback Report</h2>

                <!-- Search Form -->
                <form method="get" th:action="@{/feedbacks/analysis}" id="instructorAnalysisForm">
                    <div class="row align-items-center gy-3 mb-4">
                        <div class="col-md-6 d-flex">
                            <div class="input-group me-2 flex-grow-1">
                                <input list="instructorList" name="instructorName" id="instructorSelect" class="form-control"
                                       placeholder="Search by instructor name" onchange="this.form.submit()">
                                <datalist id="instructorList">
                                    <option value="">All Instructors</option>
                                    <option th:each="instructor : ${instructors}" th:value="${instructor.id}" th:text="${instructor.username}"></option>
                                </datalist>
                                <input type="hidden" name="instructorId" id="instructorId">
                                <button type="submit" class="btn btn-sm btn-outline-secondary" aria-label="Search" title="Search">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Charts -->
                <div th:if="${instructorChartData != null and !instructorChartData.isEmpty()}" class="row">
                    <!-- Bar Charts Container -->
                    <div class="col-md-8">
                        <div class="chart-container" style="max-height: 400px; overflow-y: auto;">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="courseKnowledgeChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="communicationSkillsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="approachabilityChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="engagementChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <canvas id="professionalismChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Pie Chart -->
                    <div class="col-md-4 d-flex flex-column align-items-center">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h3 class="text-center mb-3">Overall Ratings</h3>
                                <canvas id="instructorPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State for Instructor Charts -->
                <div th:if="${instructorChartData == null or instructorChartData.isEmpty()}" class="card border-0 shadow-sm p-4 text-center">
                    <div class="py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5>No Data Available</h5>
                        <p class="text-muted">There are no instructor feedback data available for analysis.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>


    <!-- Inject data từ Thymeleaf -->
    <script th:inline="javascript">
        window.courseChartData = /*[[${courseChartData}]]*/ {};
        window.instructorChartData = /*[[${instructorChartData}]]*/ {};
        document.addEventListener("DOMContentLoaded", function () {
            const ratingColors = [
                "rgba(128,128,128,0.8)",  // 1★
                "rgba(173,216,230,0.8)",  // 2★
                "rgba(100,149,237,0.8)",  // 3★
                "rgba(65,105,225,0.8)",   // 4★
                "rgba(0,0,255,0.8)"       // 5★
            ];

            const courseChartData = window.courseChartData || {};
            const instructorChartData = window.instructorChartData || {};

            const courseCategories = [
                "practicalApplications", "clarityOfExplanation", "courseStructure",
                "clarityOfMaterial", "supportMaterials", "uptodateMaterials"
            ];

            const instructorCategories = [
                "courseKnowledge", "communicationSkills", "approachability",
                "engagement", "professionalism"
            ];

            const drawBarChart = (ctxId, label, data) => {
                const ctx = document.getElementById(ctxId)?.getContext("2d");
                if (!ctx) return;
                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: ["1★", "2★", "3★", "4★", "5★"],
                        datasets: [{
                            label,
                            data: data || [0, 0, 0, 0, 0],
                            backgroundColor: ratingColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Number of Ratings' } },
                            x: { title: { display: true, text: 'Rating Score' } }
                        },
                        plugins: {
                            title: { display: true, text: label }
                        }
                    }
                });
            };

            const drawPieChart = (ctxId, data, title) => {
                const ctx = document.getElementById(ctxId)?.getContext("2d");
                if (!ctx) return;
                new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: ["1★", "2★", "3★", "4★", "5★"],
                        datasets: [{
                            data: data || [0, 0, 0, 0, 0],
                            backgroundColor: ratingColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: "right", labels: { boxWidth: 20 } },
                            title: { display: true, text: title }
                        }
                    }
                });
            };

            courseCategories.forEach(category => {
                const label = category.replace(/([A-Z])/g, " $1").trim();
                drawBarChart(`${category}Chart`, label, courseChartData[category]);
            });

            drawPieChart("CoursePieChart", courseChartData["overall"], "Overall Course Ratings Distribution");

            instructorCategories.forEach(category => {
                const label = category.replace(/([A-Z])/g, " $1").trim();
                drawBarChart(`${category}Chart`, label, instructorChartData[category]);
            });

            drawPieChart("instructorPieChart", instructorChartData["overall"], "Overall Instructor Ratings Distribution");

            // Xử lý datalist cho course
            document.querySelector('input[name="courseName"]').addEventListener("input", function () {
                const selectedOption = Array.from(document.querySelectorAll("#courseList option"))
                    .find(option => option.value === this.value);
                if (selectedOption) {
                    this.value = selectedOption.textContent;
                    document.getElementById("courseId").value = selectedOption.value;
                } else {
                    this.value = "";
                    document.getElementById("courseId").value = "";
                }
            });

            // Xử lý datalist cho instructor
            document.querySelector('input[name="instructorName"]').addEventListener("input", function () {
                const selectedOption = Array.from(document.querySelectorAll("#instructorList option"))
                    .find(option => option.value === this.value);
                if (selectedOption) {
                    this.value = selectedOption.textContent;
                    document.getElementById("instructorId").value = selectedOption.value;
                } else {
                    this.value = "";
                    document.getElementById("instructorId").value = "";
                }
            });
        });

    </script>

    <!-- Gọi file .js chứa logic -->
    <script th:src="@{/js/feedbacks/analysis.js}"></script>

</div>