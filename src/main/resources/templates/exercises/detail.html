<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- Th√™m CSS cho Prism.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <!-- Th√™m JS cho Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-cpp.min.js"></script>

    <!-- CodeMirror Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

    <!-- CodeMirror Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/java/java.min.js"></script>
    <!-- CodeMirror Linter -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/lint/lint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/lint/lint.min.js"></script>

    <!-- Linter cho t·ª´ng ng√¥n ng·ªØ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/lint/json-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/lint/python-lint.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/skulpt-stdlib.js"></script>



    <style>
        .CodeMirror {
            font-size: 15px !important;
            font-family: "Fira Code", monospace !important;
            line-height: 1.5 !important;
            height: auto !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Exercise Detail</h1>

    <div class="grid grid-cols-3 gap-6">
        <!-- Exercise Details -->
        <div class="bg-gray-800 p-4 rounded-lg">
            <span th:text="(${exercise.level} == 1 ? 'Easy' : (${exercise.level} == 2 ? 'Medium' : 'Hard'))"
                  class="bg-green-500 text-black px-3 py-1 rounded-full text-sm"></span>
            <h3 class="text-xl font-semibold mt-3" th:text="${exercise.title}">Loading...</h3>
            <p class="text-gray-400" th:text="${exercise.description}">Loading description...</p>
        </div>

        <!-- Exercise Code & Actions -->
        <div class="bg-gray-800 p-4 rounded-lg">
            <div class="flex justify-between mb-2">
                <span th:text="${exercise.language.name}" class="bg-blue-500 px-3 py-1 rounded text-sm"></span>
                <div>
                    <button id="reviewCodeBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-white">
                        <i class="fas fa-search"></i> Review Code
                    </button>
                    <!-- N√∫t Run Code -->
                    <button id="runCodeBtn" class="bg-green-500 px-4 py-2 rounded text-white">
                        <i class="fas fa-play-circle"></i> Run Code
                    </button>
                </div>
            </div>

            <!-- Code Editor -->
            <textarea id="editor" th:text="${#strings.trim(exercise.setupCode)}"></textarea>

        </div>

        <!-- K·∫øt qu·∫£ test case -->
        <div class="bg-gray-800 p-4 rounded-lg" id="results">
            <h3 class="text-lg font-semibold">Results:</h3>
            <p id="summary"></p>
            <div id="testCaseResults" class="max-h-[300px] overflow-y-auto bg-gray-900 text-white p-2 rounded mt-2"></div>

        </div>

    </div>

    <!-- Custom Input Section -->
    <div class="bg-gray-800 p-4 rounded-lg mt-6">
        <h3 class="text-lg font-semibold"><i class="fas fa-keyboard"></i> Custom Input</h3>
        <textarea id="customInput" class="w-full bg-gray-900 text-white p-2 rounded mt-2" placeholder="Enter your custom input here..."></textarea>
        <button id="runCustomInputBtn" class="bg-blue-500 px-4 py-2 mt-3 rounded"><i class="fas fa-play"></i> Run with Custom Input</button>

        <!-- Th√™m √¥ hi·ªÉn th·ªã output -->
        <div class="mt-4 p-3 bg-gray-700 rounded">
            <h3 class="text-lg font-semibold"><i class="fas fa-terminal"></i> Output</h3>
            <pre id="customOutput" class="max-h-[200px] overflow-y-auto bg-gray-900 text-white p-2 rounded mt-2"></pre>
        </div>
    </div>
    <a th:href="@{/exercises}" class="fixed bottom-4 right-4 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded shadow-lg z-50">
        <i class="fas fa-arrow-left mr-2"></i> Back to List
    </a>


</div>
<!-- Gi·∫£ s·ª≠ b·∫°n ƒë√£ truy·ªÅn testCasesJson t·ª´ backend -->
<!-- Test Cases Data (Hidden) -->
<div id="testCasesData" style="display: none;">
    <ul>
        <li th:each="testCase : ${testCases}">
            <span th:text="${testCase.input}"></span> |
            <span th:text="${testCase.expectedOutput}"></span>
        </li>
    </ul>
</div>
<div id="languageData" style="display: none;" th:text="${exercise.language.name}"></div>


<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: "python",  // C√≥ th·ªÉ thay ƒë·ªïi theo ng√¥n ng·ªØ ng∆∞·ªùi d√πng ch·ªçn
        theme: "dracula",
        lineNumbers: true,
        tabSize: 4,
        indentWithTabs: true,
        lint: true // K√≠ch ho·∫°t linter
    });
    editor.setOption("viewportMargin", 10); // hi·ªÉn th·ªã t·ªëi ƒëa 10 d√≤ng, s·∫Ω c√≥ scrollbar n·∫øu d√†i h∆°n


</script>

<script>
    let languageName = document.getElementById("languageData").innerText.trim();

    // B·∫£n ƒë·ªì √°nh x·∫° t·ª´ t√™n ng√¥n ng·ªØ (BE) sang language_id (Judge0)
    const languageMap = {
        "Python": 71,
        "Python2": 70,
        "Java": 91,
        "C": 50,
        "C++": 54,
        "JavaScript": 63,
        "TypeScript": 74,
        "Go": 60,
        "Ruby": 72,
        "Swift": 83,
        "Kotlin": 78,
        "PHP": 68,
        "C#": 51,
        "R": 80
    };
    let languageId = languageMap[languageName] || 71; // M·∫∑c ƒë·ªãnh l√† Python n·∫øu kh√¥ng t√¨m th·∫•y

    document.getElementById("runCodeBtn").addEventListener("click", function() {
        var code = editor.getValue(); // L·∫•y code t·ª´ CodeMirror

        // Hi·ªÉn th·ªã th√¥ng b√°o "Running..." tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu g·ª≠i y√™u c·∫ßu
        document.getElementById("summary").innerText = "Running...";

        // L·∫•y d·ªØ li·ªáu t·ª´ th·∫ª testCasesData (danh s√°ch test case)
        let testCasesDiv = document.getElementById("testCasesData");
        let testCases = [];

        // L·∫•y c√°c test case t·ª´ DOM
        testCasesDiv.querySelectorAll('li').forEach(function(item, index) {
            let input = item.querySelector('span:nth-child(1)').textContent;
            let expectedOutput = item.querySelector('span:nth-child(2)').textContent;
            testCases.push({ input: input, expectedOutput: expectedOutput });
        });

        console.log("Received test cases:", testCases); // Ki·ªÉm tra d·ªØ li·ªáu trong console

        if (!testCases || testCases.length === 0) {
            document.getElementById("summary").innerText = "‚ö†Ô∏è No test cases available!";
            return;
        }

        let passedCount = 0; // ƒê·∫øm s·ªë test case passed
        let failedResults = ''; // L∆∞u tr·ªØ k·∫øt qu·∫£ failed test cases

        // Duy·ªát qua t·∫•t c·∫£ test cases
        let promises = testCases.map((testCase, index) => {
            let input = testCase.input;
            let expectedOutput = testCase.expectedOutput.trim();

            return fetch("https://judge0-ce.p.rapidapi.com/submissions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
                    "X-RapidAPI-Key": "53bfc5030fmsh54caa4ca304a97ap1fa3f5jsnc9b1642a24e0",
                },
                body: JSON.stringify({
                    source_code: code,
                    language_id: languageId, // Python
                    stdin: input
                })
            })
                .then(response => response.json())
                .then(data => {
                    let submissionId = data.token;

                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            fetch(`https://judge0-ce.p.rapidapi.com/submissions/${submissionId}`, {
                                method: 'GET',
                                headers: {
                                    "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
                                    "X-RapidAPI-Key": "53bfc5030fmsh54caa4ca304a97ap1fa3f5jsnc9b1642a24e0"
                                }
                            })
                                .then(response => response.json())
                                .then(result => {
                                    let actualOutput = result.stdout ? result.stdout.trim() : "‚ö†Ô∏è No output received";
                                    let isPassed = actualOutput === expectedOutput;

                                    // ƒê·∫øm s·ªë test case passed
                                    if (isPassed) {
                                        passedCount++;
                                    } else {
                                        // N·∫øu test case failed, l∆∞u v√†o k·∫øt qu·∫£
                                        failedResults += `
                                <p style="color: red;"><strong>Test Case ${index + 1}:</strong> Failed</p>
                                <p><strong>Input:</strong> ${input}</p>
                                <p><strong>Your Output:</strong> ${actualOutput}</p>
                                <p><strong>Expected Output:</strong> ${expectedOutput}</p>
                                <br>
                            `;
                                    }

                                    resolve();
                                })
                                .catch(reject);
                        }, 2000); // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l·∫•y k·∫øt qu·∫£
                    });
                });
        });

        // ƒê·ª£i t·∫•t c·∫£ c√°c promises ho√†n th√†nh
        Promise.all(promises).then(() => {
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·ªïng k·∫øt
            document.getElementById("summary").innerText = `You passed ${passedCount} out of ${testCases.length} test cases.`;

            // Ch·ªâ hi·ªÉn th·ªã c√°c test case failed
            document.getElementById("testCaseResults").innerHTML = failedResults;

            // N·∫øu kh√¥ng c√≥ test case n√†o failed, hi·ªÉn th·ªã th√¥ng b√°o ƒë√£ passed t·∫•t c·∫£
            if (failedResults === '') {
                document.getElementById("testCaseResults").innerHTML = "<p style='color: green;'>All test cases passed successfully!</p>";
            }
        })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("summary").innerHTML = "‚ö†Ô∏è Error submitting code!";
            });
    });

</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        Prism.highlightAll();
    });
</script>
<script>
    document.getElementById("runCustomInputBtn").addEventListener("click", function () {
        var code = editor.getValue(); // L·∫•y code t·ª´ CodeMirror
        var customInput = document.getElementById("customInput").value; // L·∫•y input ng∆∞·ªùi d√πng nh·∫≠p

        if (!customInput.trim()) {
            alert("Please enter some input!");
            return;
        }

        // Hi·ªÉn th·ªã "ƒêang ch·∫°y..." trong output
        document.getElementById("customOutput").innerText = "Running...";

        fetch("https://judge0-ce.p.rapidapi.com/submissions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
                "X-RapidAPI-Key": "53bfc5030fmsh54caa4ca304a97ap1fa3f5jsnc9b1642a24e0",
            },
            body: JSON.stringify({
                source_code: code,
                language_id: languageId,
                stdin: customInput
            })
        })
            .then(response => response.json())
            .then(data => {
                let submissionId = data.token;

                setTimeout(() => {
                    fetch(`https://judge0-ce.p.rapidapi.com/submissions/${submissionId}`, {
                        method: 'GET',
                        headers: {
                            "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
                            "X-RapidAPI-Key": "53bfc5030fmsh54caa4ca304a97ap1fa3f5jsnc9b1642a24e0"
                        }
                    })
                        .then(response => response.json())
                        .then(result => {
                            let output = result.stdout ? result.stdout.trim() : "No Output";
                            document.getElementById("customOutput").innerText = output;
                        })
                        .catch(error => {
                            console.error('Error fetching result:', error);
                            document.getElementById("customOutput").innerText = "Error retrieving output!";
                        });
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("customOutput").innerText = "Error running code!";
            });
    });
</script>

<script>
    document.getElementById("reviewCodeBtn").addEventListener("click", async function () {
        const code = editor.getValue().trim();
        const testCaseResultsDiv = document.getElementById("testCaseResults");
        const summaryDiv = document.getElementById("summary");

        summaryDiv.innerHTML = "üîç ƒêang g·ª≠i m√£ ƒë·∫øn h·ªá th·ªëng ƒë√°nh gi√°...";
        testCaseResultsDiv.innerHTML = "";

        if (!code) {
            summaryDiv.innerText = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ ƒë·ªÉ ki·ªÉm tra.";
            return;
        }

        try {
            const response = await fetch("https://api.deepinfra.com/v1/openai/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer DYBwBaX9a0UHxpZHOSg0w2PTYA0WxY9k", // ‚ö†Ô∏è L·ªô key n·∫øu d√πng production
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "meta-llama/Meta-Llama-3-8B-Instruct",
                    messages: [
                        {
                            role: "user",
                            content: "Please review this code:\n" + code
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error("API call failed: " + response.status);
            }

            const result = await response.json();
            const reviewText = result.choices?.[0]?.message?.content || "Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ AI.";

            summaryDiv.innerHTML = "‚úÖ Ph√¢n t√≠ch ho√†n t·∫•t!";
            testCaseResultsDiv.innerHTML = `<p style='white-space: pre-wrap;'>${reviewText}</p>`;

        } catch (error) {
            summaryDiv.innerText = "‚ùå G·∫∑p l·ªói khi g·ªçi API!";
            testCaseResultsDiv.innerHTML = `<p style="color: red;">${error}</p>`;
        }
    });
</script>


</body>
</html>
