<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Điểm danh</title>
</head>
<body>
<div class="px-5" th:fragment="content">
    <div class="container-fluid mt-4">
        <!-- Header với tiêu đề và các nút chức năng -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                Điểm danh -
                <span th:if="${classInfo != null}" th:text="${classInfo.name ?: ''}"></span>
                <span th:if="${date != null}" th:text="${' - ' + #temporals.format(date, 'dd/MM/yyyy')}"></span>
            </h2>
            <!-- Đoạn code cần thay thế trong file attendance/list.html -->
            <div class="d-flex">
                <button th:if="${classInfo != null && date != null && attendanceRecords != null && !#lists.isEmpty(attendanceRecords.content)}"
                        type="button" class="btn btn-info me-2"
                        id="openClassEmailBtn"
                        data-bs-toggle="modal"
                        data-bs-target="#classEmailModal"
                        style="min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-envelope"></i> Send
                </button>
                <a th:href="@{/attendance/export/{classId}/{date}(classId=${classInfo.id}, date=${date})}"
                   class="btn btn-success me-2"
                   style="min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-file-excel"></i> Export
                </a>
                <button th:if="${classInfo != null && date != null}"
                        type="button"
                        class="btn btn-primary me-2"
                        id="importAttendanceBtn"
                        data-bs-toggle="modal"
                        data-bs-target="#importAttendanceModal"
                        style="min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-file-import"></i> Import
                </button>
                <button th:if="${classInfo != null && date != null}"
                        type="button"
                        class="btn btn-danger me-2"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteAttendanceModal"
                        style="min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <a th:href="@{/attendance/class/{classId}(classId=${classInfo.id})}"
                   class="btn btn-outline-secondary"
                   style="min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <!-- Thông báo -->
        <div th:if="${success != null}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Thông tin lớp học -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong>Thông tin lớp học</strong>
            </div>
            <div th:if="${classInfo != null}" class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>Mã lớp:</strong> <span th:text="${classInfo.classCode ?: ''}"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Ngày điểm danh:</strong> <span th:if="${date != null}" th:text="${#temporals.format(date, 'dd/MM/yyyy')}"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Điểm danh gần nhất:</strong> <span th:if="${latestAttendanceDate != null}" th:text="${#temporals.format(latestAttendanceDate, 'dd/MM/yyyy')}"></span>
                            <span th:if="${latestAttendanceDate == null}">Chưa có</span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Số học viên:</strong> <span th:text="${attendanceRecords != null ? attendanceRecords.totalElements : 0}"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Tỷ lệ tham dự:</strong> <span id="attendanceRate" th:text="${#numbers.formatDecimal(attendanceRate, 1, 2) + '%'}"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="attendanceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-attendance"
                        type="button" role="tab" aria-controls="manual-attendance" aria-selected="true">
                    <i class="fas fa-clipboard-list me-2"></i>Điểm danh thủ công
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="qr-tab" data-bs-toggle="tab" data-bs-target="#qr-attendance"
                        type="button" role="tab" aria-controls="qr-attendance" aria-selected="false">
                    <i class="fas fa-qrcode me-2"></i>Điểm danh QR
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="attendanceTabsContent">
            <!-- Tab 1: Điểm danh thủ công -->
            <div class="tab-pane fade show active" id="manual-attendance" role="tabpanel" aria-labelledby="manual-tab">
                <div th:if="${attendanceRecords == null || #lists.isEmpty(attendanceRecords.content)}" class="text-center mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-exclamation-circle"></i> <span>Chưa có dữ liệu điểm danh cho ngày này.</span>
                    </div>
                </div>

                <div th:if="${attendanceRecords != null && !#lists.isEmpty(attendanceRecords.content)}" class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                        <tr>
                            <th style="width: 50px">#</th>
                            <th style="width: 150px">Tên đăng nhập</th>
                            <th>Họ và tên</th>
                            <th>Email</th>
                            <th style="width: 120px">Trạng thái</th>
                            <th style="width: 120px">Điểm danh</th>
                            <th style="width: 120px">Vắng có phép</th>
                            <th style="width: 120px">Giờ điểm danh</th>
                            <th>Ghi chú</th>
                            <th style="width: 100px">Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <th:block th:with="activeRecords=${attendanceRecords.content.?[student != null && !student.isLocked]},
                   lockedRecords=${attendanceRecords.content.?[student != null && student.isLocked]}">
                            <tr th:each="record, stat : ${activeRecords}" class="table-row-active">
                                <td th:text="${stat.count}"></td>

                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? student.username : '-'}"></td>

                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? (student.lastName ?: '') + ' ' + (student.firstName ?: '') : '-'}"></td>

                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? student.email : '-'}"></td>

                                <td><span class="badge bg-success">Đang hoạt động</span></td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input th:if="${record != null}"
                                               class="form-check-input attendance-toggle"
                                               type="checkbox"
                                               th:id="${'attendance-' + record.id}"
                                               th:data-id="${record.id}"
                                               th:data-student-id="${record.student != null ? record.student.id : ''}"
                                               th:data-student-name="${record.student != null ? (record.student.lastName ?: '') + ' ' + (record.student.firstName ?: '') : '-'}"
                                               th:data-locked="false"
                                               th:checked="${record.isPresent != null && record.isPresent}">
                                        <label th:if="${record != null}"
                                               class="form-check-label"
                                               th:for="${'attendance-' + record.id}">
                                            <span th:if="${record.isPresent != null && record.isPresent}" class="text-success">Có mặt</span>
                                            <span th:unless="${record.isPresent != null && record.isPresent}" class="text-danger">Vắng mặt</span>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check">
                                        <input th:if="${record != null}"
                                               class="form-check-input excused-toggle"
                                               type="checkbox"
                                               th:id="${'excused-' + record.id}"
                                               th:data-id="${record.id}"
                                               th:data-locked="false"
                                               th:checked="${record.isExcused != null && record.isExcused}"
                                               th:disabled="${record.isPresent != null && record.isPresent}">
                                        <label th:if="${record != null}"
                                               class="form-check-label"
                                               th:for="${'excused-' + record.id}">
                                            Có phép
                                        </label>
                                    </div>
                                </td>
                                <td th:id="${'checkin-time-' + record.id}" th:text="${record != null && record.checkedInTime != null ? #temporals.format(record.checkedInTime, 'HH:mm:ss') : '-'}"></td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control attendance-note"
                                               th:value="${record != null ? record.notes : ''}"
                                               th:data-id="${record != null ? record.id : ''}"
                                               th:data-locked="false"
                                               placeholder="Nhập ghi chú...">
                                        <button class="btn btn-outline-secondary save-note-btn" type="button"
                                                th:data-id="${record != null ? record.id : ''}"
                                                th:data-locked="false">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-info send-email-btn"
                                            th:if="${record != null}"
                                            th:data-id="${record.id}"
                                            th:data-student-name="${record.student != null ? (record.student.lastName ?: '') + ' ' + (record.student.firstName ?: '') : '-'}"
                                            th:data-student-email="${record.student != null ? record.student.email : ''}">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </td>
                            </tr>

                            <tr th:each="record, stat : ${lockedRecords}" class="table-danger table-row-locked">
                                <td th:text="${activeRecords.size + stat.count}"></td>
                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? student.username : '-'}"></td>
                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? (student.lastName ?: '') + ' ' + (student.firstName ?: '') : '-'}"></td>
                                <td th:with="student=${record != null ? record.student : null}"
                                    th:text="${student != null ? student.email : '-'}"></td>
                                <td><span class="badge bg-danger">Đã khóa</span></td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input th:if="${record != null}"
                                               class="form-check-input attendance-toggle"
                                               type="checkbox"
                                               th:id="${'attendance-' + record.id}"
                                               th:data-id="${record.id}"
                                               th:data-locked="true"
                                               th:checked="${record.isPresent != null && record.isPresent}"
                                               disabled>
                                        <label th:if="${record != null}"
                                               class="form-check-label"
                                               th:for="${'attendance-' + record.id}">
                                            <span th:if="${record.isPresent != null && record.isPresent}"
                                                  class="text-success">Có mặt</span>
                                            <span th:unless="${record.isPresent != null && record.isPresent}"
                                                  class="text-danger">Vắng mặt</span>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check">
                                        <input th:if="${record != null}"
                                               class="form-check-input excused-toggle"
                                               type="checkbox"
                                               th:id="${'excused-' + record.id}"
                                               th:data-id="${record.id}"
                                               th:data-locked="true"
                                               th:checked="${record.isExcused != null && record.isExcused}"
                                               disabled>
                                        <label th:if="${record != null}"
                                               class="form-check-label"
                                               th:for="${'excused-' + record.id}">
                                            Có phép
                                        </label>
                                    </div>
                                </td>
                                <td id="checkin-time-${record.id}" th:text="${record != null && record.checkedInTime != null ?
                                      #temporals.format(record.checkedInTime, 'HH:mm:ss') : '-'}"></td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control attendance-note"
                                               th:value="${record != null ? record.notes : ''}"
                                               th:data-id="${record != null ? record.id : ''}"
                                               th:data-locked="true"
                                               placeholder="Nhập ghi chú..."
                                               disabled>
                                        <button class="btn btn-outline-secondary save-note-btn" type="button"
                                                th:data-id="${record != null ? record.id : ''}"
                                                th:data-locked="true"
                                                disabled>
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-info send-email-btn" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </td>
                            </tr>
                        </th:block>
                        </tbody>
                    </table>

                    <div class="text-muted mt-3 text-center">
                        <span>Tổng số sinh viên: <strong th:text="${attendanceRecords.totalElements}"></strong></span>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Điểm danh QR - Chỉ gọi đến file riêng -->
            <div class="tab-pane fade" id="qr-attendance" role="tabpanel" aria-labelledby="qr-tab">
                <!-- Gọi đến fragment qr-content trong file qr-view.html -->
                <div th:replace="attendance/qr-view :: qr-content"></div>
            </div>
        </div>
    </div>

    <!-- Gọi đến fragment chứa các modal từ file modals.html -->
    <div th:replace="attendance/modals :: attendance-modals"></div>

    <!-- JavaScript xử lý điểm danh thủ công -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const importForm = document.getElementById('importAttendanceForm');
            const importBtn = document.getElementById('btnSubmitImport');
            const importSpinner = document.getElementById('importSpinner');
            const importResult = document.getElementById('importResult');
            const attendanceFileInput = document.getElementById('attendanceFile');

            if (importBtn) {
                importBtn.addEventListener('click', function() {
                    // Kiểm tra file đã chọn chưa
                    if (!attendanceFileInput.files.length) {
                        showToast('Lỗi', 'Vui lòng chọn file Excel để import', 'error');
                        return;
                    }

                    // Hiển thị spinner, ẩn kết quả trước đó
                    importSpinner.classList.remove('d-none');
                    importResult.classList.add('d-none');

                    // Disable nút import
                    importBtn.disabled = true;

                    // Tạo FormData để gửi file
                    const formData = new FormData();
                    formData.append('file', attendanceFileInput.files[0]);
                    formData.append('classId', document.getElementById('importClassId').value);
                    formData.append('date', document.getElementById('importDate').value);

                    // Thiết lập headers
                    const headers = {};
                    const csrfMeta = document.querySelector('meta[name="_csrf"]');
                    const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

                    if (csrfMeta && csrfHeaderMeta) {
                        headers[csrfHeaderMeta.getAttribute('content')] = csrfMeta.getAttribute('content');
                    }

                    // Gửi request API
                    fetch('/attendance/import', {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Ẩn spinner
                            importSpinner.classList.add('d-none');

                            // Hiển thị kết quả
                            importResult.classList.remove('d-none');

                            if (data.status === 'success') {
                                importResult.classList.remove('alert-danger');
                                importResult.classList.add('alert-success');
                                importResult.innerHTML = `
                        <i class="fas fa-check-circle"></i> ${data.message}
                        <p class="mt-2">Tỷ lệ tham dự mới: <strong>${data.attendanceRate}%</strong></p>
                    `;

                                // Cập nhật tỷ lệ tham dự trên giao diện
                                const attendanceRateElement = document.getElementById('attendanceRate');
                                if (attendanceRateElement) {
                                    attendanceRateElement.textContent = data.attendanceRate + '%';
                                }

                                // Reset form
                                importForm.reset();

                                // Đóng modal sau 2 giây và reload trang
                                setTimeout(() => {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('importAttendanceModal'));
                                    if (modal) {
                                        modal.hide();
                                    }
                                    location.reload();
                                }, 2000);

                            } else {
                                importResult.classList.remove('alert-success');
                                importResult.classList.add('alert-danger');
                                importResult.innerHTML = `<i class="fas fa-times-circle"></i> ${data.message}`;
                            }

                            // Enable lại nút import
                            importBtn.disabled = false;
                        })
                        .catch(error => {
                            console.error('Error:', error);

                            // Ẩn spinner
                            importSpinner.classList.add('d-none');

                            // Hiển thị lỗi
                            importResult.classList.remove('d-none', 'alert-success');
                            importResult.classList.add('alert-danger');
                            importResult.innerHTML = `<i class="fas fa-times-circle"></i> Lỗi khi import: ${error.message || 'Không thể kết nối đến server'}`;

                            // Enable lại nút import
                            importBtn.disabled = false;
                        });
                });
            }

            // Xử lý sự kiện thay đổi file
            if (attendanceFileInput) {
                attendanceFileInput.addEventListener('change', function() {
                    if (this.files.length) {
                        const file = this.files[0];
                        const validTypes = [
                            'application/vnd.ms-excel',
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        ];

                        if (!validTypes.includes(file.type)) {
                            showToast('Lỗi', 'Vui lòng chọn file Excel (.xls, .xlsx)', 'error');
                            this.value = ''; // Reset input
                        }
                    }
                });
            }
            // Fix backdrop không biến mất sau khi đóng modal gửi email lớp
            const classEmailModalEl = document.getElementById('classEmailModal');
            if (classEmailModalEl) {
                classEmailModalEl.addEventListener('hidden.bs.modal', function () {
                    document.body.classList.remove('modal-open');
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                });
            }
            // CSRF Token setup
            let csrfToken = '';
            let csrfHeader = 'X-CSRF-TOKEN';
            const csrfMeta = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

            if (csrfMeta) csrfToken = csrfMeta.getAttribute('content');
            if (csrfHeaderMeta) csrfHeader = csrfHeaderMeta.getAttribute('content');

            // Lấy thông tin lớp học
            const classInfo = {
                id: /*[[${classInfo != null ? classInfo.id : 'null'}]]*/,
                name: /*[[${classInfo != null ? "'" + classInfo.name + "'" : "''"}]]*/,
                classCode: /*[[${classInfo != null ? "'" + classInfo.classCode + "'" : "''"}]]*/
            };


            const attendanceDate = /*[[${date != null ? #temporals.format(date, 'dd/MM/yyyy') : ''}]]*/;

            // Biến lưu toggle hiện tại cho modal
            let currentAttendanceToggle = null;

            // =====================================================
            // XỬ LÝ CÁC NÚT GỬI EMAIL RIÊNG LẺ
            // =====================================================

            // Event listeners cho chức năng gửi email riêng lẻ
            const emailButtons = document.querySelectorAll('.send-email-btn:not([disabled])');
            emailButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Lấy thông tin từ data attributes
                    const attendanceId = this.getAttribute('data-id');
                    const studentName = this.getAttribute('data-student-name');
                    const studentEmail = this.getAttribute('data-student-email');

                    // Thiết lập giá trị cho modal
                    document.getElementById('attendanceId').value = attendanceId;
                    document.getElementById('studentName').value = studentName;
                    document.getElementById('studentEmail').value = studentEmail;

                    // Thiết lập tiêu đề mặc định
                    document.getElementById('emailSubject').value = 'Thông báo điểm danh lớp ' + classInfo.name;

                    // Thiết lập nội dung mặc định
                    const defaultContent = `Xin chào {studentName},

Đây là thông báo về việc điểm danh lớp {className} (Mã lớp: {classCode}) vào ngày {date}.

Vui lòng xem chi tiết điểm danh của bạn trong hệ thống.

Trân trọng,
Ban quản lý đào tạo`;

                    document.getElementById('emailContent').value = defaultContent;

                    // Hiển thị modal
                    const emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
                    emailModal.show();
                });
            });

            // Xử lý sự kiện khi nhấn nút gửi email trong modal
            document.getElementById('sendEmailButton').addEventListener('click', function() {
                // Kiểm tra dữ liệu form
                const attendanceId = document.getElementById('attendanceId').value;
                const subject = document.getElementById('emailSubject').value.trim();
                const content = document.getElementById('emailContent').value.trim();

                if (!subject) {
                    showToast('Lỗi', 'Vui lòng nhập tiêu đề email', 'error');
                    return;
                }

                if (!content) {
                    showToast('Lỗi', 'Vui lòng nhập nội dung email', 'error');
                    return;
                }

                // Xử lý các biến trong nội dung
                const studentName = document.getElementById('studentName').value;
                const processedContent = content
                    .replace(/{studentName}/g, studentName)
                    .replace(/{className}/g, classInfo.name)
                    .replace(/{classCode}/g, classInfo.classCode)
                    .replace(/{date}/g, attendanceDate);

                // Gửi request API
                const requestData = {
                    attendanceId: attendanceId,
                    subject: subject,
                    content: processedContent
                };

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (csrfToken) {
                    headers[csrfHeader] = csrfToken;
                }

                // Hiển thị loading
                const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
                emailModal.hide();

                // Gửi request API
                fetch('/attendance/send-email', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                })
                    .then(response => response.json())
                    .then(result => {
                        // Hiển thị kết quả
                        const resultHeader = document.getElementById('emailResultHeader');
                        const resultBody = document.getElementById('emailResultBody');

                        if (result.success) {
                            resultHeader.className = 'modal-header bg-success text-white';
                            resultBody.innerHTML = `
                    <div class="text-center mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center">${result.message}</p>
                `;
                        } else {
                            resultHeader.className = 'modal-header bg-danger text-white';
                            resultBody.innerHTML = `
                    <div class="text-center mb-3">
                        <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center">${result.message}</p>
                `;
                        }

                        const resultModal = new bootstrap.Modal(document.getElementById('emailResultModal'));
                        resultModal.show();
                    })
                    .catch(error => {
                        console.error('Error:', error);

                        // Hiển thị lỗi
                        const resultHeader = document.getElementById('emailResultHeader');
                        const resultBody = document.getElementById('emailResultBody');

                        resultHeader.className = 'modal-header bg-danger text-white';
                        resultBody.innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">Đã xảy ra lỗi khi gửi email. Vui lòng thử lại sau.</p>
            `;

                        const resultModal = new bootstrap.Modal(document.getElementById('emailResultModal'));

                        resultModal.show();

                    });

            });

            // =====================================================
            // XỬ LÝ GỬI EMAIL CHO LỚP HỌC
            // =====================================================

            // Khai báo biến để lưu trữ dữ liệu sinh viên
            let allStudents = [];

            // Khởi tạo dữ liệu sinh viên khi trang được tải
            initializeStudentData();

            // Xử lý nút mở modal gửi email cho lớp
            const openClassEmailBtn = document.getElementById('openClassEmailBtn');
            if (openClassEmailBtn) {
                openClassEmailBtn.addEventListener('click', function() {
                    // Khởi tạo lại form và danh sách sinh viên
                    resetClassEmailForm();

                    // Sử dụng Bootstrap để mở modal
                    const classEmailModal = new bootstrap.Modal(document.getElementById('classEmailModal'));
                    classEmailModal.show();
                });
            }

            // Hàm khởi tạo dữ liệu sinh viên từ bảng điểm danh
            function initializeStudentData() {
                allStudents = [];

                // Lấy tất cả các hàng điểm danh (cả sinh viên đang hoạt động và đã khóa)
                const attendanceRows = document.querySelectorAll('.table-row-active, .table-row-locked');

                attendanceRows.forEach((row, index) => {
                    const attendanceToggle = row.querySelector('.attendance-toggle');
                    if (!attendanceToggle) return;

                    const attendanceId = attendanceToggle.getAttribute('data-id');
                    const isPresent = attendanceToggle.checked;
                    const studentName = attendanceToggle.getAttribute('data-student-name') || 'Sinh viên';

                    // Lấy email từ ô thứ 4 trong hàng
                    const emailCell = row.querySelectorAll('td')[3];
                    const email = emailCell ? emailCell.textContent.trim() : '';

                    // Kiểm tra xem sinh viên có bị khóa không
                    const isLocked = row.classList.contains('table-row-locked');
                    const studentId = attendanceToggle.getAttribute('data-student-id');
                    // Thêm vào danh sách sinh viên
                    allStudents.push({
                        id: attendanceId,
                        studentId: studentId,
                        name: studentName,
                        email: email,
                        isPresent: isPresent,
                        isLocked: isLocked,
                        index: index + 1
                    });
                });
            }

            // Hàm thiết lập lại form gửi email cho lớp
            function resetClassEmailForm() {
                // Thiết lập tiêu đề mặc định
                document.getElementById('classEmailSubject').value = 'Thông báo điểm danh lớp ' + classInfo.name;

                // Thiết lập nội dung mặc định
                const defaultContent = `Xin chào {studentName},

Đây là thông báo về việc điểm danh lớp {className} (Mã lớp: {classCode}) vào ngày {date}.

Vui lòng xem chi tiết điểm danh của bạn trong hệ thống.

Trân trọng,
Ban quản lý đào tạo`;

                document.getElementById('classEmailContent').value = defaultContent;

                // Tạo danh sách sinh viên trong bảng
                const studentEmailList = document.getElementById('studentEmailList');
                studentEmailList.innerHTML = '';

                allStudents.forEach(student => {
                    const statusClass = student.isPresent ? 'text-success' : 'text-danger';
                    const statusText = student.isPresent ? 'Có mặt' : 'Vắng mặt';
                    const disabledAttr = student.isLocked ? 'disabled' : '';

                    const row = `
            <tr>
                <td>
                    <div class="form-check">
                        <input class="form-check-input student-select" type="checkbox"
       id="select-student-${student.studentId}"
       data-student-id="${student.studentId}"
       data-present="${student.isPresent}"
       ${disabledAttr}>

                    </div>
                </td>
                <td>${student.index}</td>
                <td>${student.name}</td>
                <td>${student.email}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
            </tr>
            `;

                    studentEmailList.insertAdjacentHTML('beforeend', row);
                });

                // Cập nhật số lượng sinh viên được chọn
                updateSelectedCount();

                // Bỏ chọn ô "chọn tất cả"
                document.getElementById('checkAllStudents').checked = false;
            }

            // Xử lý ô checkbox "chọn tất cả"
            document.getElementById('checkAllStudents').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.student-select:not([disabled])').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateSelectedCount();
            });

            // Xử lý khi thay đổi các ô chọn sinh viên
            document.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('student-select')) {
                    updateSelectedCount();
                }
            });

            // Xử lý nút "Chọn tất cả"
            document.getElementById('selectAllStudentsBtn').addEventListener('click', function() {
                document.querySelectorAll('.student-select:not([disabled])').forEach(checkbox => {
                    checkbox.checked = true;
                });
                updateSelectedCount();
            });

            // Xử lý nút "Chỉ chọn sinh viên vắng"
            document.getElementById('selectAbsentStudentsBtn').addEventListener('click', function() {
                document.querySelectorAll('.student-select:not([disabled])').forEach(checkbox => {
                    const isPresent = checkbox.getAttribute('data-present') === 'true';
                    checkbox.checked = !isPresent; // Chỉ chọn sinh viên vắng mặt
                });
                updateSelectedCount();
            });

            // Xử lý nút "Bỏ chọn tất cả"
            document.getElementById('clearSelectionBtn').addEventListener('click', function() {
                document.querySelectorAll('.student-select').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.getElementById('checkAllStudents').checked = false;
                updateSelectedCount();
            });

            // Hàm cập nhật số lượng sinh viên được chọn
            function updateSelectedCount() {
                const count = document.querySelectorAll('.student-select:checked').length;
                document.getElementById('selectedStudentCount').textContent = count;
            }

            // Xử lý nút gửi email cho lớp
            // Xử lý nút gửi email cho lớp
            document.getElementById('sendClassEmailButton').addEventListener('click', function() {
                console.log("Nút gửi email đã được nhấn");

                // Lấy danh sách sinh viên được chọn
                let selectedIds = [];
                document.querySelectorAll('.student-select:checked').forEach(checkbox => {
                    selectedIds.push(checkbox.getAttribute('data-student-id'));
                });


                console.log("Các ID đã chọn:", selectedIds);
                console.log("Số lượng ID đã chọn:", selectedIds.length);

                if (selectedIds.length === 0) {
                    showToast('Lỗi', 'Vui lòng chọn ít nhất một sinh viên để gửi email', 'error');
                    return;
                }

                // Kiểm tra dữ liệu form
                const subject = document.getElementById('classEmailSubject').value.trim();
                const content = document.getElementById('classEmailContent').value.trim();

                console.log("Tiêu đề:", subject);
                console.log("Nội dung:", content.substring(0, 30) + "...");

                if (!subject) {
                    showToast('Lỗi', 'Vui lòng nhập tiêu đề email', 'error');
                    return;
                }

                if (!content) {
                    showToast('Lỗi', 'Vui lòng nhập nội dung email', 'error');
                    return;
                }

                // Đóng modal
                const classEmailModal = bootstrap.Modal.getInstance(document.getElementById('classEmailModal'));
                classEmailModal.hide();

                // Chuẩn bị dữ liệu gửi lên server
                const requestData = {
                    classId: String(classInfo.id),
                    studentIds: selectedIds,
                    subject: subject,
                    message: content
                };

                console.log("Dữ liệu gửi đi:", JSON.stringify(requestData));

                // Thiết lập headers
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (csrfToken) {
                    headers[csrfHeader] = csrfToken;
                    console.log("CSRF token đã được thêm vào headers");
                } else {
                    console.log("CSRF token không có sẵn");
                }

                // Hiển thị thông báo đang gửi
                showToast('Thông báo', 'Đang gửi email, vui lòng đợi...', 'info');

                // Thực hiện gửi request
                console.log("Bắt đầu gửi request...");

                // Gửi request API
                fetch('/attendance/reminder/send-to-class', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                })
                    .then(response => {
                        console.log("Nhận response, status:", response.status);
                        return response.json();
                    })
                    .then(result => {
                        console.log("Kết quả từ server:", result);

                        // Hiển thị kết quả
                        const resultHeader = document.getElementById('emailResultHeader');
                        const resultBody = document.getElementById('emailResultBody');

                        if (result.status === 'success') {
                            resultHeader.className = 'modal-header bg-success text-white';
                            resultBody.innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">${result.message}</p>
            `;
                        } else {
                            resultHeader.className = 'modal-header bg-danger text-white';
                            resultBody.innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">${result.message}</p>
            `;
                        }

                        const resultModal = new bootstrap.Modal(document.getElementById('emailResultModal'));
                        resultModal.show();
                    })
                    .catch(error => {
                        console.error('Lỗi khi gửi email:', error);

                        // Hiển thị lỗi
                        const resultHeader = document.getElementById('emailResultHeader');
                        const resultBody = document.getElementById('emailResultBody');

                        resultHeader.className = 'modal-header bg-danger text-white';
                        resultBody.innerHTML = `
            <div class="text-center mb-3">
                <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
            </div>
            <p class="text-center">Đã xảy ra lỗi khi gửi email: ${error.message || 'Lỗi không xác định'}</p>
        `;

                        const resultModal = new bootstrap.Modal(document.getElementById('emailResultModal'));

                        resultModal.show();

                    });
            });




            // Event listener cho các attendance toggle
            const toggles = document.querySelectorAll('.attendance-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const attendanceId = this.getAttribute('data-id');
                    const isPresent = this.checked;
                    const isLocked = this.getAttribute('data-locked') === 'true';
                    const studentName = this.getAttribute('data-student-name') || 'này';

                    if (isLocked) {
                        showToast('Thông báo', 'Không thể thay đổi trạng thái điểm danh cho học viên đã bị khóa', 'error');
                        this.checked = !isPresent;
                        return;
                    }

                    if (!isPresent) {
                        // Lưu checkbox hiện tại để xử lý sau
                        currentAttendanceToggle = this;

                        // Hiển thị modal xác nhận
                        const modal = new bootstrap.Modal(document.getElementById('absentConfirmModal'));
                        document.getElementById('studentNameInModal').textContent = studentName;
                        modal.show();
                        return;
                    }

                    // Nếu đánh dấu là có mặt, xử lý trực tiếp không cần xác nhận
                    updateAttendanceStatus(this, attendanceId, isPresent);
                });
            });

            // Xử lý sự kiện trên modal xác nhận
            document.getElementById('confirmAbsentBtn').addEventListener('click', function() {
                if (currentAttendanceToggle) {
                    const attendanceId = currentAttendanceToggle.getAttribute('data-id');
                    updateAttendanceStatus(currentAttendanceToggle, attendanceId, false);
                    bootstrap.Modal.getInstance(document.getElementById('absentConfirmModal')).hide();
                }
            });

            document.getElementById('cancelAbsentBtn').addEventListener('click', function() {
                if (currentAttendanceToggle) {
                    currentAttendanceToggle.checked = true;
                    bootstrap.Modal.getInstance(document.getElementById('absentConfirmModal')).hide();
                }
            });

            // Hàm cập nhật trạng thái điểm danh
            function updateAttendanceStatus(toggleElement, attendanceId, isPresent) {
                const params = new URLSearchParams();
                params.append('attendanceId', attendanceId);
                params.append('isPresent', isPresent);

                if (isPresent) {
                    params.append('isExcused', false);
                    const excusedCheckbox = document.getElementById('excused-' + attendanceId);
                    if (excusedCheckbox) {
                        excusedCheckbox.checked = false;
                        excusedCheckbox.disabled = true;
                    }
                } else {
                    const excusedCheckbox = document.getElementById('excused-' + attendanceId);
                    if (excusedCheckbox) {
                        excusedCheckbox.disabled = false;
                    }
                }

                if (csrfToken) params.append('_csrf', csrfToken);

                const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
                if (csrfToken) headers[csrfHeader] = csrfToken;

                fetch('/attendance/mark', {
                    method: 'POST',
                    headers: headers,
                    body: params
                })
                    .then(response => {
                        if (response.ok) {
                            return response.text().then(text => {
                                try {
                                    // Thử parse JSON, nếu không phải JSON thì xử lý như text
                                    return JSON.parse(text);
                                } catch (e) {
                                    // Nếu không phải JSON, trả về object với status dựa trên text
                                    return { status: text === 'success' ? 'success' : 'error', message: text };
                                }
                            });
                        } else {
                            throw new Error('Request failed');
                        }
                    })
                    .then(result => {
                        if (result.status === 'success') {
                            // Cập nhật UI
                            const label = toggleElement.nextElementSibling;
                            if (label) {
                                label.innerHTML = isPresent ?
                                    '<span class="text-success">Có mặt</span>' :
                                    '<span class="text-danger">Vắng mặt</span>';
                            }

                            // Cập nhật giờ điểm danh nếu có
                            if (result.checkedInTime) {
                                const timeCell = document.getElementById('checkin-time-' + attendanceId);
                                if (timeCell) {
                                    timeCell.textContent = result.checkedInTime;
                                }
                            }

                            // Cập nhật tỷ lệ tham dự nếu có
                            if (result.attendanceRate) {
                                const rateSpan = document.getElementById('attendanceRate');
                                if (rateSpan) {
                                    rateSpan.textContent = result.attendanceRate + '%';
                                }
                            }

                            showToast('Thông báo', 'Đã cập nhật trạng thái điểm danh thành công', 'success');
                        } else {
                            showToast('Lỗi', 'Cập nhật trạng thái điểm danh thất bại: ' + (result.message || ''), 'error');
                            toggleElement.checked = !isPresent;
                        }
                    })
                    .catch(error => {
                        showToast('Lỗi', 'Cập nhật trạng thái điểm danh thất bại: ' + error, 'error');
                        toggleElement.checked = !isPresent;
                    });
            }

            // Event listener cho các excused toggle
            const excusedToggles = document.querySelectorAll('.excused-toggle');
            excusedToggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const attendanceId = this.getAttribute('data-id');
                    const isExcused = this.checked;
                    const isLocked = this.getAttribute('data-locked') === 'true';

                    if (isLocked) {
                        showToast('Thông báo', 'Không thể thay đổi trạng thái điểm danh cho học viên đã bị khóa', 'error');
                        this.checked = !isExcused;
                        return;
                    }

                    const attendanceCheckbox = document.getElementById('attendance-' + attendanceId);
                    const isPresent = attendanceCheckbox && attendanceCheckbox.checked;

                    if (isExcused && isPresent) {
                        showToast('Thông báo', 'Học viên phải ở trạng thái vắng mặt mới có thể đánh dấu có phép', 'error');
                        this.checked = false;
                        return;
                    }

                    const params = new URLSearchParams();
                    params.append('attendanceId', attendanceId);
                    params.append('isPresent', false);
                    params.append('isExcused', isExcused);

                    if (csrfToken) params.append('_csrf', csrfToken);

                    const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
                    if (csrfToken) headers[csrfHeader] = csrfToken;

                    fetch('/attendance/mark', {
                        method: 'POST',
                        headers: headers,
                        body: params
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.text().then(text => {
                                    try {
                                        // Thử parse JSON, nếu không phải JSON thì xử lý như text
                                        return JSON.parse(text);
                                    } catch (e) {
                                        // Nếu không phải JSON, trả về object với status dựa trên text
                                        return { status: text === 'success' ? 'success' : 'error', message: text };
                                    }
                                });
                            } else {
                                throw new Error('Request failed');
                            }
                        })
                        .then(result => {
                            if (result.status === 'success') {
                                // Nếu đánh dấu vắng có phép và học viên đang có mặt, chuyển sang vắng mặt
                                if (isExcused && attendanceCheckbox && attendanceCheckbox.checked) {
                                    attendanceCheckbox.checked = false;
                                    const label = attendanceCheckbox.nextElementSibling;
                                    if (label) {
                                        label.innerHTML = '<span class="text-danger">Vắng mặt</span>';
                                    }
                                }

                                // Cập nhật tỷ lệ tham dự nếu có
                                if (result.attendanceRate) {
                                    const rateSpan = document.getElementById('attendanceRate');
                                    if (rateSpan) {
                                        rateSpan.textContent = result.attendanceRate + '%';
                                    }
                                }

                                showToast('Thông báo', 'Đã cập nhật trạng thái vắng có phép thành công', 'success');
                            } else {
                                showToast('Lỗi', 'Cập nhật trạng thái vắng có phép thất bại: ' + (result.message || ''), 'error');
                                this.checked = !isExcused;
                            }
                        })
                        .catch(error => {
                            showToast('Lỗi', 'Cập nhật trạng thái vắng có phép thất bại: ' + error, 'error');
                            this.checked = !isExcused;
                        });
                });
            });

            // Event listener cho các nút lưu ghi chú
            const saveNoteButtons = document.querySelectorAll('.save-note-btn');
            saveNoteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const attendanceId = this.getAttribute('data-id');
                    const isLocked = this.getAttribute('data-locked') === 'true';

                    if (isLocked) {
                        showToast('Thông báo', 'Không thể thêm ghi chú cho học viên đã bị khóa', 'error');
                        return;
                    }

                    const noteInput = document.querySelector(`.attendance-note[data-id="${attendanceId}"]`);
                    const notes = noteInput.value.trim();

                    const params = new URLSearchParams();
                    params.append('attendanceId', attendanceId);
                    params.append('notes', notes);

                    if (csrfToken) params.append('_csrf', csrfToken);

                    const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
                    if (csrfToken) headers[csrfHeader] = csrfToken;

                    fetch('/attendance/notes', {
                        method: 'POST',
                        headers: headers,
                        body: params
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.text().then(text => {
                                    try {
                                        return JSON.parse(text);
                                    } catch (e) {
                                        return { status: text === 'success' ? 'success' : 'error', message: text };
                                    }
                                });
                            } else {
                                throw new Error('Request failed');
                            }
                        })
                        .then(result => {
                            if (result.status === 'success') {
                                showToast('Thông báo', 'Đã lưu ghi chú thành công', 'success');
                            } else {
                                showToast('Lỗi', 'Lưu ghi chú thất bại: ' + (result.message || ''), 'error');
                            }
                        })
                        .catch(error => {
                            showToast('Lỗi', 'Lưu ghi chú thất bại: ' + error, 'error');
                        });
                });
            });

            // Xử lý phím Enter trên input ghi chú
            const noteInputs = document.querySelectorAll('.attendance-note:not([disabled])');
            noteInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const attendanceId = this.getAttribute('data-id');
                        const saveButton = document.querySelector(`.save-note-btn[data-id="${attendanceId}"]:not([disabled])`);
                        if (saveButton) saveButton.click();
                    }
                });
            });
        });

        // Hiển thị Toast
        function showToast(title, message, type) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    const container = document.createElement('div');
                    container.id = 'toast-container';
                    container.className = 'position-fixed bottom-0 end-0 p-3';
                    container.style.zIndex = '5';
                    document.body.appendChild(container);
                }

                const toastId = 'toast-' + new Date().getTime();
                const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

                const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} text-white">
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>`;

                document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHtml);
                const toastElement = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
                toastElement.show();

                const toastNode = document.getElementById(toastId);
                toastNode.addEventListener('hidden.bs.toast', function() {
                    toastNode.remove();
                });
            } else {
                alert(`${title}: ${message}`);
            }
        }
    </script>
</div>
</body>
</html>