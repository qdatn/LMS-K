<div class="px-3 px-md-5" th:fragment="content">
    <div class="container-fluid">
        <div class="row border rounded shadow-sm" style="height: 85vh; overflow: hidden; background: #f8f9fa;">

            <!-- Hidden Fields -->
            <div class="field" style="display: none;">
                <input id="currentUserId" name="currentUserId" required th:value="${currentUser.id}" type="text">
                <input id="currentUserUsername" name="currentUserId" required th:value="${currentUser.username}"
                       type="text">
                <input id="currentConversationId" name="currentConversationId" th:value="${currentConversation.id}"
                       type="text">
                <input id="isMessagesEmpty" type="hidden"
                       th:value="${messages == null or messages.isEmpty()} ? 'true' : 'false'">
            </div>

            <!-- Sidebar Danh Sách Người Dùng -->
            <div class="col-lg-3 col-md-4 col-12 p-0 border-end bg-white" style="height: 85vh; transition: all 0.3s;">
                <div class="p-3 border-bottom bg-light sticky-top">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0 fw-bold text-dark">Conversations</h5>
                        <a class="btn btn-outline-primary btn-sm rounded-circle" th:href="@{/chat/create}">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                    </div>

                    <div class="input-group mb-2 position-relative">
                        <button id="backBtn" class="btn btn-outline-secondary me-2 d-none" type="button">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="input-group-text bg-white border-end-0" id="search-addon">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 shadow-sm" placeholder="Search users..."
                               aria-label="Search" aria-describedby="search-addon" id="searchInput">
                    </div>
                </div>

                <ul class="list-group list-group-flush overflow-auto" id="conversationList"
                    style="height: calc(85vh - 120px);">
                </ul>
            </div>

            <!-- Placeholder for Message Area -->
            <div id="messageAreaContainer" class="col-lg-9 col-md-8 col-12 d-flex flex-column" style="height: 75vh;">
                <!-- Nội dung sẽ được tải động -->
            </div>

        </div>
    </div>

    <!-- Sticker Picker Modal -->
    <div class="modal fade" id="stickerModal" tabindex="-1" aria-labelledby="stickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stickerModalLabel">Choose a Sticker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sticker-container d-flex flex-wrap justify-content-center gap-2">
                        <!-- Stickers will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog"
         aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa đoạn chat này không? Hành động này không thể hoàn tác.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                            id="closeDeleteModalBtnFooter">Hủy
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function (options) {
            // Biến toàn cục
            let allConversations = [];
            let loading = false;
            let offset = 0;
            let currentPage = 0;
            const limit = 8;

            // Sticker pack - predefined stickers
            const stickerPack = [
                {id: 1, url: '/sticker/sticker_1.png', alt: 'Sticker 1'},
                {id: 2, url: '/sticker/sticker_2.png', alt: 'Sticker 2'},
            ];

            // Thêm biến cho ô tìm kiếm và danh sách người dùng
            var searchInput = $("#searchInput");
            var conversationList = $("#conversationList");
            var backBtn = $("#backBtn");
            var inputGroup = searchInput.closest('.input-group');

            var messageAreaContainer = document.querySelector('#messageAreaContainer');
            var stompClient = null;
            var messageSubscription = null; // Lưu subscription cho tin nhắn
            var callSubscription = null; // Lưu subscription cho cuộc gọi
            var currentUserId = Number($("#currentUserId").val());
            var currentUserUsername = $("#currentUserUsername").val();
            var currentConversationId = $("#currentConversationId").val();

            // Sticker related elements
            const stickerBtn = document.getElementById('stickerBtn');
            const stickerModal = new bootstrap.Modal(document.getElementById('stickerModal'));
            const stickerContainer = document.querySelector('.sticker-container');

            // Load stickers into the sticker picker
            function loadStickers() {
                stickerContainer.innerHTML = '';
                stickerPack.forEach(sticker => {
                    const stickerElement = document.createElement('div');
                    stickerElement.classList.add('sticker-item');
                    stickerElement.innerHTML = `
                        <img src="${sticker.url}" alt="${sticker.alt}" class="img-fluid" style="width: 80px; height: 80px; cursor: pointer">
                    `;
                    stickerElement.addEventListener('click', () => {
                        sendSticker(sticker);
                        stickerModal.hide();
                    });
                    stickerContainer.appendChild(stickerElement);
                });
            }

            // Send sticker function
            function sendSticker(sticker) {
                sendMessage({
                    preventDefault: () => {
                    }
                }, sticker.url, 'sticker');
            }

            // Show sticker picker when button is clicked
            if (stickerBtn) {
                stickerBtn.addEventListener('click', () => {
                    loadStickers();
                    stickerModal.show();
                });
            }

            // WebRTC variables
            var localVideo = document.getElementById('localVideo');
            var remoteVideo = document.getElementById('remoteVideo');
            var videoCallContainer = document.getElementById('videoCallContainer');
            var startVideoCallBtn = document.getElementById('startVideoCallBtn');
            var endCallBtn = document.getElementById('endCallBtn');
            var callNotification = document.getElementById('callNotification');
            var peerConnection = null;
            var localStream = null;
            var pendingCandidates = [];
            var isCallActive = false;
            var callStartTime = null;
            const MIN_CALL_DURATION = 3000;

            // Hàm load thêm conversations
            function loadConversations() {
                if (loading) return;
                loading = true;

                $.ajax({
                    url: "/chat/conversations",
                    method: "GET",
                    dataType: "json",
                    data: {page: currentPage, size: limit},
                    xhrFields: {withCredentials: true},
                    success: function (data) {
                        if (data.content && Array.isArray(data.content)) {
                            data.content.forEach(conversation => {
                                if (conversation.lastMessageTime) {
                                    conversation.lastMessageTime = new Date(conversation.lastMessageTime).toLocaleString('en-GB', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                } else {
                                    conversation.lastMessageTime = "11/11/1111 11:11";
                                }
                                renderConversationItem(conversation, $("#conversationList"));
                            });
                            currentPage++;
                        } else {
                            console.error("Dữ liệu trả về không phải là một mảng:", data);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi tải danh sách cuộc trò chuyện.", {
                            status: status,
                            httpStatus: xhr.status,
                            error: error,
                            response: xhr.responseText,
                        });
                        alert("Lỗi khi tải danh sách cuộc trò chuyện.");
                    },
                    complete: function () {
                        loading = false;
                    },
                });
            }

            // Hàm render một conversation item
            function renderConversationItem(conversation, list) {
                const isGroup = !!conversation.name; // Kiểm tra nếu là cuộc trò chuyện nhóm
                const avatarClass = isGroup ? 'bg-primary' : 'bg-secondary'; // Màu nền cho avatar
                let avatarContent;
                if (isGroup) {
                    avatarContent = '<i class="fas fa-users"></i>'; // Biểu tượng cho nhóm
                } else {
                    const initial = conversation.opponentName && conversation.opponentName.length > 0
                        ? conversation.opponentName.charAt(0).toUpperCase()
                        : "N";
                    avatarContent = `<span>${initial}</span>`; // Ký tự đầu tiên cho cá nhân
                }

                const item = `
                    <li class="list-group-item border-0 p-0" data-user-id="${conversation.id}">
                        <div class="d-flex align-items-center p-3 hover-bg-light transition-all">
                            <a href="#" class="text-decoration-none text-dark d-flex align-items-center flex-grow-1 conversation-link" data-conversation-id="${conversation.id}">
                                <div class="position-relative me-3">
                                    <div class="rounded-circle ${avatarClass} d-flex justify-content-center align-items-center text-white"
                                         style="width: 45px; height: 45px; font-size: 1.2rem;">
                                        ${avatarContent}
                                    </div>
                                    <span class="position-absolute bottom-0 end-0 p-1 bg-success rounded-circle"
                                        style="width: 12px; height: 12px;"></span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>${conversation.opponentName}</strong>
                                    </div>
                                    <div class="small text-muted text-truncate user-last-message" style="max-width: 180px;">
                                        ${conversation.lastMessage}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <small class="text-muted user-time">${conversation.lastMessageTime}</small>
                                    </div>
                                </div>
                            </a>

                            <!-- Nút menu "..." với Dropdown -->
                            <div class="dropdown ms-2">
                                <button class="btn btn-sm btn-outline-secondary rounded-circle" type="button" data-bs-toggle="dropdown"
                                    aria-expanded="false" style="padding: 2px 6px;">
                                    <i class="bi bi-three-dots"></i>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item block-user" href="#" data-conversation-id="${conversation.id}"><i
                                                class="bi bi-person-x me-2"></i>Chặn</a></li>
                                    <li><a class="dropdown-item report-user" href="#" data-conversation-id="${conversation.id}"><i
                                                class="bi bi-flag me-2"></i>Báo cáo</a></li>
                                    <li><a class="dropdown-item mark-unread" href="#" data-conversation-id="${conversation.id}"><i
                                                class="bi bi-envelope-open me-2"></i>Đánh dấu là chưa đọc</a></li>
                                    <li><a class="dropdown-item view-profile" href="#" data-conversation-id="${conversation.id}"><i
                                                class="bi bi-person me-2"></i>Xem trang cá nhân</a></li>
                                    <div class="dropdown-divider"></div>
                                    <li>
                                        <a class="dropdown-item delete-conversation text-danger" href="#" data-toggle="modal"
                                            data-target="#confirmDeleteModal" data-conversation-id="${conversation.id}">
                                            <i class="bi bi-trash me-2"></i>Xóa đoạn chat
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                `;

                list.append(item);
            }

            // Hàm render cho item khi tìm kiếm
            function renderUsersItem(user, list) {
                const opponentNameInitial = user.firstName && user.firstName.length > 0
                    ? user.firstName.charAt(0).toUpperCase()
                    : "N";

                const usersItem = `
                    <li class="list-group-item border-0 p-0" data-user-id="${user.id}">
                        <div class="d-flex align-items-center p-3 hover-bg-light transition-all">
                            <a href="#" class="text-decoration-none text-dark d-flex align-items-center flex-grow-1 start-conversation" data-user-id="${user.id}">
                                <div class="position-relative me-3">
                                    <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white" style="width: 45px; height: 45px; font-size: 1.2rem;">
                                        <span>${opponentNameInitial}</span>
                                    </div>
                                    <span class="position-absolute bottom-0 end-0 p-1 bg-success rounded-circle" style="width: 12px; height: 12px;"></span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>${user.firstName} ${user.lastName}</strong>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </li>
                `;
                list.append(usersItem);
            }

            // Hàm load nội dung Message Area (sửa đổi phần WebSocket)
            function loadMessageArea(conversationId) {
                $.ajax({
                    url: `/chat/${conversationId}/messages`,
                    method: "GET",
                    success: function (data) {
                        messageAreaContainer.innerHTML = data;

                        // Cập nhật currentConversationId
                        currentConversationId = conversationId;
                        $("#currentConversationId").val(conversationId);

                        // Khởi tạo lại các phần tử và sự kiện
                        initializeMessageArea();

                        // Cập nhật WebSocket subscription
                        if (stompClient && stompClient.connected) {
                            // Hủy subscription cũ nếu tồn tại
                            if (messageSubscription) {
                                messageSubscription.unsubscribe();
                                messageSubscription = null;
                            }
                            if (callSubscription) {
                                callSubscription.unsubscribe();
                                callSubscription = null;
                            }
                            // Đăng ký subscription mới
                            messageSubscription = stompClient.subscribe(`/chat/${conversationId}`, onMessageReceived);
                            callSubscription = stompClient.subscribe(`/topic/call/${conversationId}`, onCallSignalReceived);
                        }

                        // Cuộn xuống dưới cùng
                        const messageArea = document.querySelector('#messageArea');
                        if (messageArea) {
                            messageArea.scrollTop = messageArea.scrollHeight;
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi tải tin nhắn:", error);
                        messageAreaContainer.innerHTML = '<p class="text-muted p-3">Lỗi khi tải tin nhắn.</p>';
                    }
                });
            }

            // Khởi tạo các phần tử và sự kiện trong Message Area
            function initializeMessageArea() {
                var messageArea = document.querySelector('#messageArea');
                var messageForm = document.querySelector('#messageForm');
                var messageInput = document.querySelector('#messageInput');
                localVideo = document.getElementById('localVideo');
                remoteVideo = document.getElementById('remoteVideo');
                videoCallContainer = document.getElementById('videoCallContainer');
                startVideoCallBtn = document.getElementById('startVideoCallBtn');
                endCallBtn = document.getElementById('endCallBtn');
                callNotification = document.getElementById('callNotification');

                if (messageForm) {
                    messageForm.addEventListener('submit', sendMessage, true);
                }

                // Khởi tạo các sự kiện khác
                initializeAdditionalFeatures();
            }

            // Khởi tạo các tính năng bổ sung
            function initializeAdditionalFeatures() {
                // Speech to Text
                const speechToTextBtn = document.getElementById('speechToTextBtn');
                if (speechToTextBtn) {
                    speechToTextBtn.addEventListener('click', function () {
                        const speechButton = document.getElementById("speechToTextBtn");
                        const messageInput = document.getElementById("messageInput");
                        const messageForm = document.getElementById("messageForm");

                        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                            speechButton.disabled = true;
                            speechButton.title = "Trình duyệt không hỗ trợ Speech-to-Text";
                            return;
                        }

                        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                        recognition.lang = "vi-VN";
                        recognition.interimResults = false;
                        recognition.maxAlternatives = 1;
                        let isListening = false;

                        speechButton.addEventListener("click", () => {
                            if (!isListening) {
                                isListening = true;
                                speechButton.classList.add("btn-danger");
                                recognition.start();
                            } else {
                                isListening = false;
                                recognition.abort();
                                speechButton.classList.remove("btn-danger");
                            }
                        });

                        recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            messageInput.value = transcript;
                        };

                        recognition.onend = () => {
                            if (isListening) {
                                recognition.start();
                            } else {
                                speechButton.classList.remove("btn-danger");
                                if (messageInput.value.trim() !== "") {
                                    setTimeout(() => {
                                        messageForm.dispatchEvent(new Event("submit", {bubbles: true}));
                                    }, 500);
                                }
                            }
                        };

                        recognition.onerror = (event) => {
                            console.error("Lỗi nhận diện giọng nói:", event.error);
                            if (event.error !== "aborted") {
                                isListening = false;
                                speechButton.classList.remove("btn-danger");
                            }
                        };
                    }, false);
                }

                // Upload Widget
                const uploadWidget = document.getElementById('uploadWidget');
                if (uploadWidget) {
                    uploadWidget.addEventListener('click', function () {
                        cloudinary.openUploadWidget({
                            cloudName: 'dorvllntp',
                            uploadPreset: 'lmschat',
                            sources: ['local', 'url', 'camera'],
                            multiple: true,
                            resourceType: 'auto',
                            maxFileSize: 10485760
                        }, function (error, result) {
                            if (error) {
                                if (error.message === 'File size exceeds the maximum limit') {
                                    alert('File quá lớn! Vui lòng chọn file nhỏ hơn 10 MB.');
                                } else {
                                    console.error('Lỗi tải file:', error);
                                }
                            } else if (result && result.event === "success") {
                                var fileUrl = result.info.secure_url;
                                var fileType = result.info.resource_type === 'image' ? 'image/' + result.info.format :
                                    result.info.resource_type === 'video' ? 'video/' + result.info.format :
                                        'application/' + (result.info.format || 'unknown');
                                console.log('Sending file:', fileUrl, fileType);
                                sendMessage({
                                    preventDefault: () => {
                                    }
                                }, fileUrl, fileType);
                            }
                        });
                    }, false);
                }

                // Location
                const locationBtn = document.getElementById('locationBtn');
                if (locationBtn) {
                    locationBtn.addEventListener('click', function () {
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                function (position) {
                                    const lat = position.coords.latitude;
                                    const lng = position.coords.longitude;
                                    const locationUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                                    const locationMessage = `📍 My current location: ${locationUrl}`;
                                    document.getElementById('messageInput').value = locationMessage;
                                },
                                function (error) {
                                    console.error("Error getting location:", error);
                                    let errorMessage = "Unable to get current location. ";
                                    if (error.code === 1) {
                                        errorMessage += "You've denied location access.";
                                    } else if (error.code === 2) {
                                        errorMessage += "Location is currently unavailable.";
                                    } else if (error.code === 3) {
                                        errorMessage += "Location request timed out.";
                                    }
                                    alert(errorMessage);
                                },
                                {
                                    enableHighAccuracy: true,
                                    timeout: 10000,
                                    maximumAge: 0
                                }
                            );
                        } else {
                            alert("Your browser doesn't support GPS location.");
                        }
                    }, false);
                }

                // Sticker Button
                const stickerBtn = document.getElementById('stickerBtn');
                if (stickerBtn) {
                    stickerBtn.addEventListener('click', () => {
                        loadStickers();
                        stickerModal.show();
                    });
                }

                // Video Call
                if (startVideoCallBtn) {
                    startVideoCallBtn.addEventListener('click', () => {
                        const inviteSignal = {
                            type: 'call-invite',
                            data: JSON.stringify({
                                callerId: currentUserId,
                                callerUsername: currentUserUsername
                            })
                        };
                        stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify(inviteSignal));
                        startVideoCall(true).catch(error => {
                            console.error("Failed to start video call:", error);
                        });
                    });
                }

                if (endCallBtn) {
                    endCallBtn.addEventListener('click', () => {
                        const timeElapsed = Date.now() - callStartTime;
                        if (timeElapsed < MIN_CALL_DURATION) {
                            alert(`Vui lòng đợi ${Math.ceil((MIN_CALL_DURATION - timeElapsed) / 1000)} giây trước khi kết thúc cuộc gọi.`);
                            return;
                        }
                        stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify({
                            type: 'end-call',
                            data: ''
                        }));
                        endCall();
                    });
                }
            }

            // Load conversations ban đầu
            loadConversations();

            // Xử lý click vào conversation
            $(document).on("click", ".conversation-link", function (e) {
                e.preventDefault();
                const conversationId = $(this).data("conversation-id");

                // Cập nhật URL
                history.pushState({conversationId: conversationId}, '', `/chat/${conversationId}`);

                // Cập nhật trạng thái active
                $(".list-group-item").removeClass("active-conversation");
                $(this).closest(".list-group-item").addClass("active-conversation");

                // Tải Message Area
                loadMessageArea(conversationId);
            });

            // Xử lý popstate
            window.addEventListener('popstate', function (event) {
                if (event.state && event.state.conversationId) {
                    loadMessageArea(event.state.conversationId);
                    $(".list-group-item").removeClass("active-conversation");
                    $(`[data-user-id="${event.state.conversationId}"]`).addClass("active-conversation");
                } else {
                    messageAreaContainer.innerHTML = '<p class="text-muted p-3">Vui lòng chọn một cuộc trò chuyện.</p>';
                }
            });

            // Khởi tạo Message Area ban đầu nếu có conversationId
            if (currentConversationId) {
                loadMessageArea(currentConversationId);
                $(`[data-user-id="${currentConversationId}"]`).addClass("active-conversation");
            }

            $(document).on("click", ".start-conversation", function (e) {
                e.preventDefault();
                const opponentId = $(this).data("user-id");
                const currentUserId = $("#currentUserId").val();

                $.ajax({
                    url: "/chat/start-conversation",
                    method: "POST",
                    data: {opponentId: opponentId, currentUserId: currentUserId},
                    xhrFields: {withCredentials: true},
                    success: function (conversationId) {
                        history.pushState({conversationId: conversationId}, '', `/chat/${conversationId}`);
                        loadMessageArea(conversationId);
                        clickBackBtn();
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi tạo cuộc trò chuyện:", error);
                        alert("Lỗi khi tạo cuộc trò chuyện.");
                    }
                });
            });

            // WebRTC Configuration
            const configuration = {
                iceServers: [
                    {urls: 'stun:stun.l.google.com:19302'},
                    {
                        urls: "turn:relay1.expressturn.com:3478",
                        username: "your_turn_username",
                        credential: "your_turn_credential"
                    }
                ]
            };

            // Chức năng delete
            let conversationIdToDelete = null;
            $(document).on("click", ".delete-conversation", function () {
                conversationIdToDelete = $(this).data("conversation-id");
                $("#confirmDeleteModal").modal("show");
            });

            $(document).on("click", "#closeDeleteModalBtn, #closeDeleteModalBtnFooter", function () {
                $("#confirmDeleteModal").modal("hide");
                conversationIdToDelete = null;
            });

            $(document).on("click", "#confirmDeleteBtn", function () {
                if (conversationIdToDelete) {
                    $.ajax({
                        url: `/chat/delete/${conversationIdToDelete}`,
                        type: "POST",
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function () {
                            const conversationItem = $(`li[data-user-id="${conversationIdToDelete}"]`);
                            if (conversationItem.length) {
                                conversationItem.remove();
                            }
                            if (currentConversationId == conversationIdToDelete) {
                                messageAreaContainer.innerHTML = '<p class="text-muted p-3">Vui lòng chọn một cuộc trò chuyện.</p>';
                                history.pushState({}, '', '/chat');
                            }
                            $("#confirmDeleteModal").modal("hide");
                            window.location.href = "/chat";
                            conversationIdToDelete = null;
                        },
                        error: function (xhr, status, error) {
                            console.error("Lỗi khi xóa đoạn chat:", error);
                            alert("Lỗi khi xóa đoạn chat.");
                        }
                    });
                }
            });

            // Ẩn danh sách khi nhấp vào ô tìm kiếm (focus)
            searchInput.on('focus', function () {
                backBtn.removeClass('d-none'); // Hiển thị nút Back
                inputGroup.addClass('focused'); // Thêm class để thụt ô tìm kiếm
            });

            // Hiện lại danh sách khi rời khỏi ô tìm kiếm (blur)
            searchInput.on('blur', function () {
                // Không làm gì để giữ nguyên chức năng gốc
            });

            // Khi nhấp vào nút Back
            backBtn.on('click', function () {
                clickBackBtn();

            });

            function clickBackBtn() {
                backBtn.addClass('d-none');
                inputGroup.removeClass('focused');
                searchInput.val('');
                currentPage = 0;
                allConversations = [];
                conversationList.empty();
                loading = false;
                loadConversations();
            }

            let loadedCount = 0;

            let debounceTimeout;
            searchInput.on('input', function () {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(filterUsers, 300);
            });

            function filterUsers() {
                var searchTerm = searchInput.val().trim().toLowerCase();
                conversationList.empty(); // Xóa danh sách cũ
                loadedCount = 0; // Reset vị trí tải dữ liệu

                if (searchTerm === "") {
                    loadConversations(); // Tải lại danh sách thông thường
                } else {
                    loadMoreUsers(searchTerm, 0);
                }
            }

            // Tải thêm khi cuộn xuống dưới cùng
            conversationList.on("scroll", function () {
                const scrollThreshold = 35;
                if (!loading && $(this).scrollTop() + $(this).innerHeight() >= this.scrollHeight - scrollThreshold) {
                    const searchTerm = searchInput.val().trim().toLowerCase();
                    if (searchTerm === "") {
                        loadConversations();
                    } else {
                        loadMoreUsers(searchTerm, loadedCount);
                    }
                }
            });

            function loadMoreUsers(searchTerm, offset) {
                if (loading) return; // Ngăn gửi request nếu đang tải
                loading = true;

                $.ajax({
                    url: "/chat/search",
                    method: "GET",
                    data: {searchTerm: searchTerm, offset: offset, limit: limit},
                    success: function (data) {
                        if (data.length > 0) {
                            data.forEach(function (conversation) {
                                renderUsersItem(conversation, conversationList);
                            });
                            loadedCount += data.length;
                        } else if (offset === 0) {
                            conversationList.html('<li class="list-group-item text-muted">Không tìm thấy người dùng nào.</li>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi tìm kiếm:", error);
                    },
                    complete: function () {
                        loading = false;
                    }
                });
            }

            // WebSocket connection
            if (currentUserId && currentUserUsername) {
                var socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, onConnected, onError);
            }

            function onConnected() {
                console.log("Connected to WebSocket");
                // Chỉ đăng ký subscription nếu có currentConversationId
                if (currentConversationId) {
                    messageSubscription = stompClient.subscribe(`/chat/${currentConversationId}`, onMessageReceived);
                    callSubscription = stompClient.subscribe(`/topic/call/${currentConversationId}`, onCallSignalReceived);
                }
            }

            function onError() {
                console.error('Could not connect to WebSocket server.');
                alert('Không thể kết nối đến WebSocket. Vui lòng làm mới trang để thử lại!');
            }

            function sendMessage(event, mediaUrl = null, mediaType = null) {
                event.preventDefault();
                var messageInput = document.querySelector('#messageInput');
                var messageContent = mediaUrl ? '' : messageInput.value.trim();

                if ((messageContent || mediaUrl) && stompClient) {
                    const conversationItem = $(`[data-user-id="${currentConversationId}"]`);
                    const isNewConversation = !conversationItem.length;
                    console.log("Is this a new conversation?", isNewConversation);

                    const chatMessage = {
                        text: messageContent,
                        mediaUrl: mediaUrl,
                        mediaType: mediaType,
                        timestamp: new Date().toISOString(),
                        user: { id: currentUserId },
                        conversation: { id: currentConversationId }
                    };
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                    messageInput.value = '';

                    // Nếu là cuộc trò chuyện mới, làm mới danh sách
                    if (isNewConversation) {
                        setTimeout(() => {
                            currentPage = 0;
                            allConversations = [];
                            conversationList.empty();
                            loading = false;
                            loadConversations();
                        }, 200);
                    } else {
                        // Cập nhật mục hiện có trong danh sách
                        const lastMessageElement = conversationItem.find('.user-last-message');
                        if (lastMessageElement) {
                            lastMessageElement.text(messageContent || "Media");
                        }
                    }
                }
            }

            function onMessageReceived(payload) {
                console.log("Payload received:", payload);
                const message = JSON.parse(payload.body);

                const messageElement = document.createElement('div');
                messageElement.classList.add('d-flex', 'mb-3', 'animate-message');
                messageElement.classList.add(message.user.id === currentUserId ? 'justify-content-end' : 'justify-content-start');

                const messageContent = document.createElement('div');
                messageContent.classList.add('p-3', 'rounded', 'shadow-sm', 'message-bubble');
                messageContent.style.maxWidth = '60%';
                if (message.user.id === currentUserId) {
                    messageContent.classList.add('alert', 'alert-primary');
                } else {
                    messageContent.classList.add('bg-white', 'text-dark');
                }

                const headerDiv = document.createElement('div');
                headerDiv.classList.add('d-flex', 'justify-content-between');

                const senderName = document.createElement('small');
                senderName.classList.add('fw-bold');
                senderName.innerText = (message.user.lastName || '') + ' ' + (message.user.firstName || '');
                headerDiv.appendChild(senderName);

                messageContent.appendChild(headerDiv);

                if (message.mediaType !== 'sticker') {
                    const messageText = document.createElement('span');
                    if (message.text && message.text.includes('📍 My current location: https://www.google.com/maps')) {
                        const locationText = document.createElement('span');
                        locationText.innerText = '📍 Current location: ';

                        const locationLink = document.createElement('a');
                        const mapUrl = message.text.split(': ')[1];
                        locationLink.href = mapUrl;
                        locationLink.target = '_blank';
                        locationLink.innerText = mapUrl;
                        locationLink.classList.add('text-decoration-underline');

                        messageText.appendChild(locationText);
                        messageText.appendChild(locationLink);
                    } else {
                        messageText.innerText = message.text;
                    }
                    messageContent.appendChild(messageText);
                }

                const timestampDiv = document.createElement('div');
                timestampDiv.classList.add('mt-1', 'text-end');

                const timestamp = document.createElement('small');
                timestamp.classList.add('message-timestamp');
                if (message.user.id === currentUserId) {
                    timestamp.classList.add('text-primary'); // Màu xanh đậm cho người gửi
                } else {
                    timestamp.classList.add('text-muted'); // Màu xám nhạt cho người nhận
                }
                let formattedTime = "N/A";
                if (message.timestamp) {
                    let ts = message.timestamp;
                    if (ts && ts.length > 23) {
                        ts = ts.substring(0, 23) + 'Z';
                    }
                    const date = new Date(ts);
                    if (!isNaN(date.getTime())) {
                        date.setHours(date.getHours() - 7);
                        formattedTime = date.toLocaleString('en-GB', {
                            hour: '2-digit',
                            minute: '2-digit',
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }).replace(',', '');
                    }
                }
                timestamp.innerText = formattedTime;
                timestampDiv.appendChild(timestamp);
                messageContent.appendChild(timestampDiv);

                if (message.mediaUrl) {
                    const mediaDiv = document.createElement('div');
                    if (message.mediaType === 'sticker') {
                        const stickerImg = document.createElement('img');
                        stickerImg.classList.add('img-fluid', 'rounded', 'mt-1');
                        stickerImg.style.width = '150px';
                        stickerImg.style.height = '150px';
                        stickerImg.src = message.mediaUrl;
                        stickerImg.alt = 'Sticker';
                        mediaDiv.appendChild(stickerImg);
                    } else if (message.mediaType && message.mediaType.startsWith('image')) {
                        const mediaImage = document.createElement('img');
                        mediaImage.classList.add('img-fluid', 'rounded', 'mt-1');
                        mediaImage.style.width = '400px';
                        mediaImage.style.height = '300px';
                        mediaImage.src = message.mediaUrl;
                        mediaImage.alt = 'Image';
                        mediaDiv.appendChild(mediaImage);
                    } else if (message.mediaType && message.mediaType.startsWith('video')) {
                        const mediaVideo = document.createElement('video');
                        mediaVideo.classList.add('rounded', 'mt-1');
                        mediaVideo.style.width = '400px';
                        mediaVideo.style.height = '300px';
                        mediaVideo.controls = true;
                        const source = document.createElement('source');
                        source.src = message.mediaUrl;
                        source.type = message.mediaType;
                        mediaVideo.appendChild(source);
                        mediaVideo.appendChild(document.createTextNode('Trình duyệt của bạn không hỗ trợ thẻ video.'));
                        mediaDiv.appendChild(mediaVideo);
                    } else {
                        const mediaLinkContainer = document.createElement('div');
                        mediaLinkContainer.style.display = 'flex';
                        mediaLinkContainer.style.alignItems = 'center';
                        const mediaLink = document.createElement('a');
                        mediaLink.href = message.mediaUrl;
                        mediaLink.target = '_blank';
                        mediaLink.classList.add('text-decoration-underline');
                        const fileIcon = document.createElement('img');
                        fileIcon.src = 'https://cdn.pixabay.com/photo/2014/04/03/00/40/document-309065_640.png';
                        fileIcon.alt = 'File Icon';
                        fileIcon.style.width = '50px';
                        fileIcon.style.height = '50px';
                        fileIcon.style.marginRight = '10px';
                        mediaLinkContainer.appendChild(fileIcon);
                        mediaLinkContainer.appendChild(mediaLink);
                        mediaDiv.appendChild(mediaLinkContainer);
                    }
                    messageContent.appendChild(mediaDiv);
                }

                messageElement.appendChild(messageContent);
                const messageArea = document.querySelector('#messageArea');
                if (messageArea) {
                    messageArea.appendChild(messageElement);
                }

                const conversationItem = document.querySelector(`[data-user-id="${message.conversation.id}"]`);
                if (conversationItem) {
                    const lastMessageElement = conversationItem.querySelector('.user-last-message');
                    if (lastMessageElement) {
                        if (message.mediaType === 'sticker') {
                            lastMessageElement.textContent = 'Sticker';
                        } else {
                            lastMessageElement.textContent = message.text;
                        }
                    }

                    const lastMessageTimeElement = conversationItem.querySelector('.user-time');
                    if (lastMessageTimeElement) {
                        let ts = message.timestamp;
                        if (ts && ts.length > 23) {
                            ts = ts.substring(0, 23) + 'Z';
                        }
                        const date = new Date(ts);
                        date.setHours(date.getHours() - 7);
                        const formattedTime = date.toLocaleString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        lastMessageTimeElement.textContent = formattedTime;
                    }
                }

                const conversationListEl = document.querySelector('#conversationList');
                if (conversationListEl && conversationItem && conversationItem.parentNode) {
                    conversationListEl.prepend(conversationItem);
                }

                if (messageArea) {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            }

            // WebRTC Logic
            function onCallSignalReceived(payload) {
                const signal = JSON.parse(payload.body);
                console.log("Signal received:", signal);

                if (signal.type === 'call-invite') {
                    const callerData = JSON.parse(signal.data);
                    if (callerData.callerId !== currentUserId) {
                        document.getElementById('callerName').textContent = callerData.callerUsername;
                        callNotification.classList.remove('d-none');

                        document.getElementById('acceptCallBtn').onclick = () => {
                            startVideoCall(false).then(() => {
                                callNotification.classList.add('d-none');
                            }).catch(error => {
                                console.error("Failed to accept call:", error);
                                callNotification.classList.add('d-none');
                            });
                        };

                        document.getElementById('rejectCallBtn').onclick = () => {
                            callNotification.classList.add('d-none');
                        };
                    }
                } else if (signal.type === 'offer') {
                    handleOffer(signal.data);
                } else if (signal.type === 'answer') {
                    handleAnswer(signal.data);
                } else if (signal.type === 'ice-candidate') {
                    handleIceCandidate(signal.data);
                } else if (signal.type === 'end-call') {
                    endCall();
                }
            }

            startVideoCallBtn.addEventListener('click', () => {
                const inviteSignal = {
                    type: 'call-invite',
                    data: JSON.stringify({
                        callerId: currentUserId,
                        callerUsername: currentUserUsername
                    })
                };
                stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify(inviteSignal));
                console.log("Call invite sent:", inviteSignal);
                startVideoCall(true).catch(error => {
                    console.error("Failed to start video call:", error);
                });
            });

            async function startVideoCall(isCaller) {
                try {
                    isCallActive = true;
                    callStartTime = Date.now(); // Ghi lại thời gian bắt đầu cuộc gọi

                    console.log("Requesting media access...");
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    console.log("Local stream acquired:", localStream);

                    const videoTracks = localStream.getVideoTracks();
                    const audioTracks = localStream.getAudioTracks();
                    console.log("Local video tracks:", videoTracks);
                    console.log("Local audio tracks:", audioTracks);

                    if (videoTracks.length === 0) {
                        throw new Error("No video tracks available in local stream");
                    }
                    if (audioTracks.length === 0) {
                        throw new Error("No audio tracks available in local stream");
                    }

                    localVideo.srcObject = localStream;
                    const localPlayPromise = localVideo.play();
                    if (localPlayPromise !== undefined) {
                        localPlayPromise.then(() => {
                            console.log("Local video playback started successfully");
                        }).catch(error => {
                            console.error("Failed to play local video:", error);
                            throw error;
                        });
                    }

                    peerConnection = new RTCPeerConnection(configuration);

                    localStream.getTracks().forEach(track => {
                        console.log("Adding track to peerConnection:", track);
                        peerConnection.addTrack(track, localStream);
                    });

                    const senders = peerConnection.getSenders();
                    console.log("Tracks added to peerConnection:", senders);

                    peerConnection.ontrack = (event) => {
                        console.log("ontrack event fired:", event);
                        console.log("Remote streams received:", event.streams);
                        if (!isCallActive) {
                            console.warn("Call is no longer active, ignoring ontrack event");
                            return;
                        }
                        if (event.streams && event.streams[0]) {
                            const remoteStream = event.streams[0];
                            console.log("Remote stream tracks:", remoteStream.getTracks());
                            remoteVideo.srcObject = remoteStream;
                            if (!remoteVideo.autoplay || remoteVideo.paused) {
                                const remotePlayPromise = remoteVideo.play();
                                if (remotePlayPromise !== undefined) {
                                    remotePlayPromise.then(() => {
                                        console.log("Remote video playback started successfully");
                                    }).catch(error => {
                                        console.error("Failed to play remote video:", error);
                                        if (error.name === 'AbortError') {
                                            console.warn("Remote video play interrupted, likely due to call ending");
                                        }
                                    });
                                }
                            }
                        } else {
                            console.error("No streams received in ontrack event");
                        }
                    };

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log("ICE candidate generated:", event.candidate);
                            stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify({
                                type: 'ice-candidate',
                                data: JSON.stringify(event.candidate)
                            }));
                        } else {
                            console.log("ICE gathering complete");
                        }
                    };

                    peerConnection.oniceconnectionstatechange = () => {
                        console.log("ICE Connection State:", peerConnection.iceConnectionState);
                        if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                            console.error("ICE connection failed or disconnected");
                            endCall();
                        } else if (peerConnection.iceConnectionState === 'connected') {
                            console.log("ICE connection established successfully");
                        }
                    };

                    peerConnection.onconnectionstatechange = () => {
                        console.log("Connection State:", peerConnection.connectionState);
                        if (peerConnection.connectionState === 'failed') {
                            console.error("Peer connection failed");
                            endCall();
                        }
                    };

                    videoCallContainer.classList.remove('d-none');

                    if (isCaller) {
                        const offerOptions = {
                            offerToReceiveAudio: 1,
                            offerToReceiveVideo: 1
                        };
                        const offer = await peerConnection.createOffer(offerOptions);
                        console.log("Offer created:", offer);
                        await peerConnection.setLocalDescription(offer);
                        console.log("Local description set with offer");
                        stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify({
                            type: 'offer',
                            data: JSON.stringify(offer)
                        }));
                    }
                } catch (error) {
                    console.error("Error starting video call:", error);
                    endCall();
                    throw error;
                }
            }

            async function handleOffer(offerData) {
                try {
                    if (!peerConnection) {
                        await startVideoCall(false);
                    }

                    const offer = new RTCSessionDescription(JSON.parse(offerData));
                    console.log("Received offer:", offer);

                    await peerConnection.setRemoteDescription(offer);
                    console.log("Remote description set with offer");

                    const answer = await peerConnection.createAnswer();
                    console.log("Answer created:", answer);
                    await peerConnection.setLocalDescription(answer);
                    console.log("Local description set with answer");

                    stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify({
                        type: 'answer',
                        data: JSON.stringify(answer)
                    }));

                    while (pendingCandidates.length > 0) {
                        const candidate = pendingCandidates.shift();
                        console.log("Applying pending ICE candidate:", candidate);
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(error => {
                            console.error("Error applying pending ICE candidate:", error);
                        });
                    }
                } catch (error) {
                    console.error("Error handling offer:", error);
                }
            }

            async function handleAnswer(answerData) {
                try {
                    const answer = new RTCSessionDescription(JSON.parse(answerData));
                    console.log("Received answer:", answer);

                    await peerConnection.setRemoteDescription(answer);
                    console.log("Remote description set with answer");

                    while (pendingCandidates.length > 0) {
                        const candidate = pendingCandidates.shift();
                        console.log("Applying pending ICE candidate:", candidate);
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(error => {
                            console.error("Error applying pending ICE candidate:", error);
                        });
                    }
                } catch (error) {
                    console.error("Error handling answer:", error);
                }
            }

            async function handleIceCandidate(candidateData) {
                try {
                    const candidate = JSON.parse(candidateData);
                    console.log("Received ICE candidate:", candidate);

                    if (peerConnection && peerConnection.remoteDescription) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        console.log("ICE candidate added successfully");
                    } else {
                        console.warn("Remote description not set, queuing ICE candidate");
                        pendingCandidates.push(candidate);
                    }
                } catch (error) {
                    console.error("Error adding ICE candidate:", error);
                }
            }

            endCallBtn.addEventListener('click', () => {
                // Kiểm tra thời gian tối thiểu trước khi kết thúc cuộc gọi
                const timeElapsed = Date.now() - callStartTime;
                if (timeElapsed < MIN_CALL_DURATION) {
                    alert(`Vui lòng đợi ${Math.ceil((MIN_CALL_DURATION - timeElapsed) / 1000)} giây trước khi kết thúc cuộc gọi để đảm bảo kết nối ổn định.`);
                    return;
                }
                stompClient.send(`/app/call/${currentConversationId}`, {}, JSON.stringify({
                    type: 'end-call',
                    data: ''
                }));
                endCall();
            });

            function endCall() {
                isCallActive = false;

                // Chỉ gọi pause() nếu video đang phát
                if (localVideo.srcObject && !localVideo.paused) {
                    localVideo.pause();
                }
                if (remoteVideo.srcObject && !remoteVideo.paused) {
                    remoteVideo.pause();
                }

                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                    console.log("Peer connection closed");
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                    console.log("Local stream stopped");
                }
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                videoCallContainer.classList.add('d-none');
                pendingCandidates = [];
                callStartTime = null;
                console.log("Call ended and resources cleaned up");
            }
        });
    </script>
</div>